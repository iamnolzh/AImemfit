// 登录/认证检查：复现手动 curl 测试（首页 GET、登录 POST、检查 302/响应头）
// 用法：yak login_check.yak --target http://192.168.3.24:8080 [--login-path /login.php] [--username admin] [--password password]
__DESC__ = "登录与认证检查：GET 首页、GET 登录页（可选取 token）、POST 登录、检查 302/Location/Set-Cookie，供 Yak 参与手动测试流程"
__VERBOSE_NAME__ = "登录认证检查"
__KEYWORDS__ = "login,auth,302,redirect,manual-test,yak"

target = cli.String("target", cli.setRequired(true), cli.setHelp("目标 base URL，如 http://192.168.3.24:8080"))
loginPath = cli.String("login-path", cli.setDefault("/login.php"), cli.setHelp("登录路径"))
username = cli.String("username", cli.setDefault("admin"), cli.setHelp("登录用户名"))
password = cli.String("password", cli.setDefault("password"), cli.setHelp("登录密码"))
cli.check()

aiOut = func(msg) {
    try { yakit.AIOutput(msg) } catch { println(msg) }
}

raw = str.TrimSpace(target)
baseUrl = raw
if !str.HasSuffix(baseUrl, "/") { baseUrl = baseUrl + "/" }
isHttps = str.HasPrefix(raw, "https://")
loginUrl = baseUrl + str.TrimLeft(loginPath, "/")
if str.HasSuffix(raw, "/") { loginUrl = str.TrimSuffix(raw, "/") + loginPath }

// 1) GET 首页
req1, err := poc.ParseUrlToHTTPRequestRaw("GET", baseUrl)
if err != nil {
    aiOut(sprintf("[登录检查] 构建 GET 首页请求失败: %v", err))
} else {
    r1, _, err := poc.HTTP(req1, poc.https(isHttps), poc.connTimeout(10))
    if err != nil {
        aiOut(sprintf("[登录检查] GET 首页失败: %v", err))
    } else {
        code1 = poc.GetStatusCodeFromResponse(r1)
        aiOut(sprintf("[登录检查] GET / => %v", code1))
        body1 = str.ExtractBodyFromHTTPResponseRaw(r1)
        if len(body1) > 0 {
            aiOut(sprintf("[首页响应] 前 200 字符: %s", str.Substr(string(body1), 0, 200)))
        }
    }
}

// 2) GET 登录页（可选：取 user_token）
req2, err := poc.ParseUrlToHTTPRequestRaw("GET", loginUrl)
userToken = ""
if err != nil {
    aiOut(sprintf("[登录检查] 构建 GET %s 失败: %v", loginPath, err))
} else {
    r2, _, err := poc.HTTP(req2, poc.https(isHttps), poc.connTimeout(10))
    if err != nil {
        aiOut(sprintf("[登录检查] GET %s 失败: %v", loginPath, err))
    } else {
        code2 = poc.GetStatusCodeFromResponse(r2)
        aiOut(sprintf("[登录检查] GET %s => %v", loginPath, code2))
        body2 = str.ExtractBodyFromHTTPResponseRaw(r2)
        tokenMatch = str.FindSubmatch(string(body2), `name=["']user_token["']\s+value=["']([^"']+)["']`)
        if len(tokenMatch) >= 2 {
            userToken = tokenMatch[1]
            aiOut(sprintf("[登录检查] 从登录页提取 user_token: %s", userToken))
        }
    }
}

// 3) POST 登录（需手造 POST 包，因 ParseUrlToHTTPRequestRaw 多为 GET）
postBody = sprintf("username=%s&password=%s&Login=Login", username, password)
if userToken != "" {
    postBody = sprintf("username=%s&password=%s&Login=Login&user_token=%s", username, password, userToken)
}
postReq = poc.BasicRequest()
postReq = poc.ReplaceHTTPPacketFirstLine(postReq, "POST", loginPath, "HTTP/1.1")
postReq = poc.AppendHTTPPacketHeader(postReq, "Content-Type", "application/x-www-form-urlencoded")
postReq = poc.AppendHTTPPacketBody(postReq, []byte(postBody), false)
// 从 base URL 取 Host
u, _ = str.Split(raw, "://")
rest = u[1]
if str.Contains(rest, "/") { rest = str.Split(rest, "/")[0] }
postReq = poc.AppendHTTPPacketHeaderIfNotExist(postReq, "Host", rest)

r3, _, err := poc.HTTP(postReq, poc.https(isHttps), poc.connTimeout(10))
if err != nil {
    aiOut(sprintf("[登录检查] POST %s 失败: %v", loginPath, err))
} else {
    code3 = poc.GetStatusCodeFromResponse(r3)
    aiOut(sprintf("[登录检查] POST %s => %v", loginPath, code3))
    loc = poc.GetHTTPPacketHeader(r3, "Location")
    if loc != "" { aiOut(sprintf("[响应头] Location: %s", loc)) }
    cookie = poc.GetHTTPPacketHeader(r3, "Set-Cookie")
    if cookie != "" { aiOut(sprintf("[响应头] Set-Cookie: %s", str.Substr(cookie, 0, 120))) }
    if code3 == 302 {
        aiOut("[登录检查] 检测到 302 重定向，请结合 Location 与 Set-Cookie 判断登录结果。")
    }
}

aiOut("=== 登录检查完成（Yak 已参与） ===")
