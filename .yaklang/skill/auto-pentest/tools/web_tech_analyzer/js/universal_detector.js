(() => {
  const detection = {
    // 框架检测
    frameworks: {},
    // 库检测
    libraries: {},
    // 打包工具检测
    bundlers: {},
    // 网络库检测
    network: {},
    // 应用类型检测
    appTypes: {},
    // 技术特征检测
    features: {},
    // 性能和资源检测
    resources: {}
  };

  // 1. 框架检测
  detection.frameworks = {
    vue: {
      detected: !!(window.Vue || window.__VUE_DEVTOOLS_GLOBAL_HOOK__ || document.querySelector('[data-v-]')),
      version: (() => {
        try {
          if (window.Vue && window.Vue.version) return window.Vue.version;
          if (window.__VUE_DEVTOOLS_GLOBAL_HOOK__) return 'devtools-detected';
          return null;
        } catch (e) { return null; }
      })(),
      router: !!(window.router || window.VueRouter),
      vuex: !!(window.Vuex || window.store)
    },

    react: {
      detected: !!(window.__REACT_DEVTOOLS_GLOBAL_HOOK__ || document.querySelector('[data-reactroot], [data-reactid]')),
      version: (() => {
        try {
          if (window.React && window.React.version) return window.React.version;
          return null;
        } catch (e) { return null; }
      })(),
      router: !!(window.ReactRouter || window.ReactRouterDOM),
      redux: !!(window.Redux || window.redux)
    },

    angular: {
      detected: !!(window.ng || document.querySelector('[ng-version]')),
      version: (() => {
        try {
          const el = document.querySelector('[ng-version]');
          return el ? el.getAttribute('ng-version') : null;
        } catch (e) { return null; }
      })(),
      router: !!(window.ng && window.ng.router)
    },

    jquery: {
      detected: !!(window.jQuery || window.$),
      version: (() => {
        try {
          return window.jQuery ? window.jQuery.fn.jquery : null;
        } catch (e) { return null; }
      })()
    },

    layui: {
      detected: !!window.layui,
      version: (() => {
        try {
          return window.layui ? window.layui.v : null;
        } catch (e) { return null; }
      })()
    }
  };

  // 2. 库检测
  detection.libraries = {
    bootstrap: {
      detected: !!(window.bootstrap || document.querySelector('[class*="btn btn-"], [class*="container"]')),
      version: (() => {
        try {
          return window.bootstrap ? window.bootstrap.Tooltip.VERSION : null;
        } catch (e) { return null; }
      })()
    },

    echarts: {
      detected: !!window.echarts,
      version: (() => {
        try {
          return window.echarts ? window.echarts.version : null;
        } catch (e) { return null; }
      })()
    },

    d3: {
      detected: !!window.d3,
      version: (() => {
        try {
          return window.d3 ? window.d3.version : null;
        } catch (e) { return null; }
      })()
    },

    lodash: {
      detected: !!window._,
      version: (() => {
        try {
          return window._ ? window._.VERSION : null;
        } catch (e) { return null; }
      })()
    },

    moment: {
      detected: !!window.moment,
      version: (() => {
        try {
          return window.moment ? window.moment.version : null;
        } catch (e) { return null; }
      })()
    }
  };

  // 3. 打包工具检测
  detection.bundlers = {
    webpack: {
      detected: !!(window.__webpack_require__ || document.querySelector('script[src*="chunk"]')),
      hasHotReload: !!window.__webpack_require__,
      chunks: (() => {
        try {
          return document.querySelectorAll('script[src*="chunk"]').length;
        } catch (e) { return 0; }
      })()
    },

    vite: {
      detected: !!(window.__VITE__ || document.querySelector('script[src*="/assets/"]')),
      version: (() => {
        try {
          return window.__VITE__ || null;
        } catch (e) { return null; }
      })(),
      assets: (() => {
        try {
          return document.querySelectorAll('script[src*="/assets/"]').length;
        } catch (e) { return 0; }
      })()
    },

    requirejs: {
      detected: !!window.requirejs,
      config: (() => {
        try {
          return window.requirejs && window.requirejs.s && window.requirejs.s.contexts &&
                 window.requirejs.s.contexts._ && window.requirejs.s.contexts._.config ? true : false;
        } catch (e) { return false; }
      })()
    }
  };

  // 4. 网络库检测
  detection.network = {
    axios: {
      detected: !!window.axios,
      version: (() => {
        try {
          return window.axios ? window.axios.VERSION : null;
        } catch (e) { return null; }
      })(),
      interceptors: (() => {
        try {
          return window.axios && window.axios.interceptors ? true : false;
        } catch (e) { return false; }
      })()
    },

    fetch: {
      detected: typeof window.fetch === 'function',
      native: (() => {
        try {
          return window.fetch.toString().includes('[native code]');
        } catch (e) { return false; }
      })()
    },

    jqueryAjax: {
      detected: !!(window.jQuery && window.jQuery.ajax),
      version: detection.frameworks.jquery.version
    },

    xmlhttprequest: {
      detected: typeof window.XMLHttpRequest === 'function'
    }
  };

  // 5. 应用类型检测
  detection.appTypes = {
    loginPage: (() => {
      const loginSelectors = [
        'input[type="password"]',
        '[class*="login"]',
        '[id*="login"]',
        'form[action*="login"]',
        '[data-testid*="login"]'
      ];
      return loginSelectors.some(selector => document.querySelector(selector));
    })(),

    adminSystem: (() => {
      const adminSelectors = [
        '[class*="admin"]',
        '[class*="dashboard"]',
        '[class*="management"]',
        '[id*="admin"]',
        '[data-role*="admin"]'
      ];
      return adminSelectors.some(selector => document.querySelector(selector));
    })(),

    spa: (() => {
      // 检查是否有前端路由特征
      return !!(
        window.history.pushState ||
        window.router ||
        window.__ROUTES__ ||
        document.querySelector('[data-router-view], [data-reactroot]')
      );
    })(),

    pwa: (() => {
      return !!(
        'serviceWorker' in navigator ||
        window.matchMedia('(display-mode: standalone)').matches ||
        document.querySelector('link[rel="manifest"]')
      );
    })()
  };

  // 6. 技术特征检测
  detection.features = {
    es6Modules: (() => {
      return !!document.querySelector('script[type="module"]');
    })(),

    inlineScripts: (() => {
      return Array.from(document.scripts).some(s => !s.src);
    })(),

    dataAttributes: (() => {
      try {
        return !!document.querySelector('[data-testid], [data-v-], [data-reactroot]');
      } catch (e) { return false; }
    })(),

    preload: (() => {
      return !!document.querySelector('link[rel="preload"], link[rel="prefetch"]');
    })(),

    webcomponents: (() => {
      return !!(window.customElements && window.customElements.define);
    })(),

    webgl: (() => {
      try {
        const canvas = document.createElement('canvas');
        return !!(canvas.getContext('webgl') || canvas.getContext('experimental-webgl'));
      } catch (e) { return false; }
    })(),

    localStorage: (() => {
      try {
        return typeof Storage !== 'undefined';
      } catch (e) { return false; }
    })(),

    indexedDB: (() => {
      return !!(window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB);
    })()
  };

  // 7. 资源和性能检测
  detection.resources = {
    scripts: {
      total: document.scripts.length,
      external: Array.from(document.scripts).filter(s => s.src).length,
      inline: Array.from(document.scripts).filter(s => !s.src).length
    },

    stylesheets: {
      total: document.styleSheets.length,
      external: Array.from(document.querySelectorAll('link[rel="stylesheet"]')).length
    },

    images: {
      total: document.images.length,
      lazy: Array.from(document.images).filter(img => img.loading === 'lazy').length
    },

    performance: (() => {
      if (!window.performance || !window.performance.getEntriesByType) return null;
      const resources = window.performance.getEntriesByType('resource');
      return {
        total: resources.length,
        scripts: resources.filter(r => r.initiatorType === 'script').length,
        xhr: resources.filter(r => r.initiatorType === 'xmlhttprequest').length,
        fetch: resources.filter(r => r.initiatorType === 'fetch').length
      };
    })()
  };

  return JSON.stringify(detection);
})();