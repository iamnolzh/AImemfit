(() => {
  // 智能分析流水线 - 一键执行完整的自适应分析
  const pipeline = {
    stages: [],
    results: {},
    executionTime: {},
    errors: []
  };

  const startTime = Date.now();

  // Stage 1: 技术栈检测
  try {
    pipeline.stages.push('detection');
    const detectorStart = Date.now();

    const detectorScript = `(() => {
      const detection = {
        frameworks: {},
        libraries: {},
        bundlers: {},
        network: {},
        appTypes: {},
        features: {},
        resources: {}
      };

      // 框架检测
      detection.frameworks = {
        vue: !!(window.Vue || window.__VUE_DEVTOOLS_GLOBAL_HOOK__ || document.querySelector('[data-v-]')),
        react: !!(window.__REACT_DEVTOOLS_GLOBAL_HOOK__ || document.querySelector('[data-reactroot], [data-reactid]')),
        angular: !!(window.ng || document.querySelector('[ng-version]')),
        jquery: !!(window.jQuery || window.$),
        layui: !!window.layui
      };

      // 库检测
      detection.libraries = {
        bootstrap: !!(window.bootstrap || document.querySelector('[class*="btn btn-"]')),
        echarts: !!window.echarts,
        d3: !!window.d3
      };

      // 打包工具检测
      detection.bundlers = {
        webpack: !!(window.__webpack_require__ || document.querySelector('script[src*="chunk"]')),
        vite: !!(window.__VITE__ || document.querySelector('script[src*="/assets/"]')),
        requirejs: !!window.requirejs
      };

      // 网络库检测
      detection.network = {
        axios: !!window.axios,
        fetch: typeof window.fetch === 'function'
      };

      // 应用类型检测
      detection.appTypes = {
        loginPage: !!document.querySelector('input[type="password"], [class*="login"]'),
        adminSystem: !!document.querySelector('[class*="admin"], [class*="dashboard"]'),
        spa: !!(window.history.pushState || window.router),
        pwa: !!('serviceWorker' in navigator)
      };

      // 技术特征检测
      detection.features = {
        es6Modules: !!document.querySelector('script[type="module"]'),
        inlineScripts: Array.from(document.scripts).some(s => !s.src),
        dataAttributes: Array.from(document.querySelectorAll('*')).some(el => el.dataset && Object.keys(el.dataset).length > 0),
        preload: !!document.querySelector('link[rel="preload"]')
      };

      return detection;
    })()`;

    const detection = eval(detectorScript);
    pipeline.results.detection = detection;
    pipeline.executionTime.detection = Date.now() - detectorStart;

  } catch (e) {
    pipeline.errors.push({ stage: 'detection', error: e.message });
  }

  // Stage 2: 动态变量检测
  try {
    pipeline.stages.push('dynamic_vars');
    const varsStart = Date.now();

    const varsScript = `(() => {
      const results = {
        dollarVars: [],
        underscoreVars: [],
        configLikeVars: [],
        routerVars: [],
        apiVars: []
      };

      const allKeys = Object.keys(window);

      allKeys.forEach(key => {
        try {
          const val = window[key];
          if (key.startsWith('$')) {
            results.dollarVars.push({
              name: key,
              type: typeof val,
              value: typeof val === 'object' ? '[Object]' :
                     typeof val === 'function' ? '[Function]' :
                     String(val).slice(0, 50)
            });
          }
          if (key.startsWith('__')) {
            results.underscoreVars.push({
              name: key,
              type: typeof val,
              value: typeof val === 'object' ? '[Object]' :
                     typeof val === 'function' ? '[Function]' :
                     String(val).slice(0, 50)
            });
          }
        } catch (e) {}
      });

      return results;
    })()`;

    const vars = eval(varsScript);
    pipeline.results.dynamic_vars = vars;
    pipeline.executionTime.dynamic_vars = Date.now() - varsStart;

  } catch (e) {
    pipeline.errors.push({ stage: 'dynamic_vars', error: e.message });
  }

  // Stage 3: 自适应脚本执行
  try {
    pipeline.stages.push('adaptive_execution');

    const detection = pipeline.results.detection || {};
    const prioritizedScripts = [];

    // 基于检测结果确定优先级脚本（添加空值检查）
    if (detection.frameworks && detection.frameworks.vue) prioritizedScripts.push('vue_routes.js');
    if (detection.frameworks && detection.frameworks.react) prioritizedScripts.push('react_routes.js');
    if (detection.frameworks && detection.frameworks.angular) prioritizedScripts.push('angular_routes.js');
    if (detection.bundlers && detection.bundlers.requirejs) {
      prioritizedScripts.push('collect_requirejs_config.js');
      prioritizedScripts.push('collect_requirejs_fetched.js');
    }
    if (detection.network && (detection.network.axios || detection.network.fetch)) prioritizedScripts.push('hook_network.js');
    if (detection.appTypes && detection.appTypes.pwa) prioritizedScripts.push('detect_service_worker.js');
    if (detection.features && detection.features.es6Modules) prioritizedScripts.push('collect_es_modules.js');
    if (detection.features && detection.features.inlineScripts) prioritizedScripts.push('collect_inline.js');

    // 始终执行的核心脚本
    const coreScripts = [
      'collect_scripts.js',
      'collect_key_scripts.js',
      'collect_generic_config.js',
      'collect_perf_resources.js',
      'routes_all.js',
      'extract_dynamic_routes.js'
    ];

    pipeline.results.adaptive_plan = {
      prioritized: prioritizedScripts,
      core: coreScripts,
      total_scripts: prioritizedScripts.length + coreScripts.length
    };

  } catch (e) {
    pipeline.errors.push({ stage: 'adaptive_execution', error: e.message });
  }

  // Stage 4: 资源统计
  try {
    pipeline.stages.push('resource_stats');
    const statsStart = Date.now();

    const stats = {
      scripts: {
        total: document.scripts.length,
        external: Array.from(document.scripts).filter(s => s.src).length,
        inline: Array.from(document.scripts).filter(s => !s.src).length
      },
      network: {
        hasAxios: !!window.axios,
        hasFetch: typeof window.fetch === 'function',
        hasJqueryAjax: !!(window.jQuery && window.jQuery.ajax)
      },
      features: {
        hasServiceWorker: 'serviceWorker' in navigator,
        hasWebGL: (() => {
          try {
            const canvas = document.createElement('canvas');
            return !!(canvas.getContext('webgl') || canvas.getContext('experimental-webgl'));
          } catch (e) { return false; }
        })(),
        hasLocalStorage: (() => {
          try { return typeof Storage !== 'undefined'; } catch (e) { return false; }
        })()
      }
    };

    pipeline.results.resource_stats = stats;
    pipeline.executionTime.resource_stats = Date.now() - statsStart;

  } catch (e) {
    pipeline.errors.push({ stage: 'resource_stats', error: e.message });
  }

  pipeline.executionTime.total = Date.now() - startTime;

  // 生成执行建议
  pipeline.recommendations = [];

  const detection = pipeline.results.detection;
  if (detection) {
    if (detection.frameworks && detection.frameworks.vue) pipeline.recommendations.push('检测到Vue.js应用，建议执行vue_routes.js获取路由信息');
    if (detection.frameworks && detection.frameworks.react) pipeline.recommendations.push('检测到React应用，建议执行react_routes.js获取路由信息');
    if (detection.frameworks && detection.frameworks.angular) pipeline.recommendations.push('检测到Angular应用，建议执行angular_routes.js获取路由信息');
    if (detection.network && detection.network.axios) pipeline.recommendations.push('检测到Axios，建议执行hook_network.js拦截网络请求');
    if (detection.appTypes && detection.appTypes.pwa) pipeline.recommendations.push('检测到PWA应用，建议执行detect_service_worker.js分析Service Worker');
    if (detection.features && detection.features.es6Modules) pipeline.recommendations.push('检测到ES6模块，建议执行collect_es_modules.js分析模块依赖');
  }

  return JSON.stringify(pipeline);
})();
