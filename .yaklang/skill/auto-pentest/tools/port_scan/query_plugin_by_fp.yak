    __DESC__ = "一个基于指纹名称查找相关插件的工具，通过计算指纹名称与插件名称的相似度来匹配和排序最相关的插件，支持模糊匹配和相似度计算。"
    __VERBOSE_NAME__ = "插件指纹查询工具"
    __KEYWORDS__ = "插件查询,指纹匹配,相似度计算,插件搜索,数据库查询,模糊匹配,plugin query,fingerprint matching,similarity calculation,plugin search,database query,fuzzy matching,yak plugin,script search"

    fpNames = cli.String("fingerprints", cli.setHelp("指纹名列表，格式：端口:指纹，多个用逗号分隔，如 '80:pikachu,443:thinkphp'"), cli.setRequired(true))
    limit = 5
    cli.check()

    allScriptCh = db.YieldYakScriptAll()
    allScript = []
    for i in allScriptCh{
        allScript.Append(i)
    }

    // 提取产品名称（去除版本号和其他信息）
    extractProductName = (fpName) => {
        fpName = str.TrimSpace(fpName)
        if fpName == "" {
            return fpName
        }
        
        // 使用字符串处理方式提取产品名称
        // 例如 "ThinkPHP 5.x" -> "ThinkPHP", "Weblogic Server" -> "Weblogic"
        
        // 先按空格分割
        parts = str.Split(fpName, " ")
        if len(parts) == 0 {
            return fpName
        }
        
        // 提取第一个单词作为产品名称
        firstPart = str.TrimSpace(parts[0])
        if firstPart == "" {
            return fpName
        }
        
        // 检查第一个部分是否包含数字（可能是版本号的一部分，如 "v1.0"）
        // 如果包含数字，可能是版本号，尝试提取前面的部分
        if re.Match("\\d", firstPart) {
            // 如果第一个部分包含数字，可能是 "v1.0" 这样的格式，返回原名称
            // 或者尝试提取非数字部分
            return firstPart
        }
        
        // 如果第一个部分不包含数字，检查第二个部分是否是版本号
        // 例如 "ThinkPHP 5.x" -> "ThinkPHP"
        if len(parts) > 1 {
            secondPart = str.TrimSpace(parts[1])
            // 检查是否是版本号格式：数字.x, v数字, version 数字等
            if re.Match("^\\d+\\.x$", secondPart) || re.Match("^v\\d+", secondPart) || re.Match("^\\d+\\.\\d+$", secondPart) {
                // 第二个部分是版本号，返回第一个部分
                return firstPart
            }
        }
        
        // 默认返回第一个单词
        return firstPart
    }

    // 查询插件函数
    queryFp = (fpName)=>{
        // 提取产品名称（去除版本号）
        productName = extractProductName(fpName)
        
        scriptInfos = []
        scriptNameMap = {}
        addScriptName = (name,desc)=>{
            if name in scriptNameMap{
                return
            }
            // 过滤掉"查询"相关的插件
            nameLower = str.ToLower(name)
            descLower = str.ToLower(desc)
            if str.Contains(nameLower, "查询") || str.Contains(nameLower, "query") || 
            str.Contains(descLower, "查询") || str.Contains(descLower, "query") {
                return
            }
            scriptInfos.Append({"name":name,"desc":desc})
            scriptNameMap[name] = true
        }

        scriptList = []
        for i in allScript{
            // 使用产品名称进行相似度计算和匹配
            sim = str.CalcSimilarity(productName,str.ToLower(i.ScriptName))
            scriptList.Append([sim,i])
            if re.Match("(?i).*%s.*"%productName, i.ScriptName) || re.Match("(?i).*%s.*"%productName, i.Help){
                addScriptName(i.ScriptName,i.Help)
            }
        }

        x.Sort(scriptList, (x,y)=> scriptList[x][0] > scriptList[y][0])

        // 降低相似度阈值到 0.2，提高匹配率
        scriptList = x.Filter(scriptList,(d)=>d[0] > 0.2)

        if len(scriptList) > limit{
            scriptList = scriptList[:limit]
        }
        x.Foreach(scriptList, d=>{
            addScriptName(d[1].ScriptName,d[1].Help)
        })
        
        return scriptInfos
    }

    // 检查是否为端口映射格式（包含冒号且格式为 端口:指纹）
    isPortMappingFormat = false
    items = str.Split(fpNames, ",")
    for item in items {
        item = str.TrimSpace(item)
        if str.Contains(item, ":") {
            parts = str.Split(item, ":")
            if len(parts) >= 2 {
                portPart = str.TrimSpace(parts[0])
                // 检查第一部分是否为数字（端口）
                if re.Match("^\\d+$", portPart) {
                    isPortMappingFormat = true
                    break
                }
            }
        }
    }

    if isPortMappingFormat {
        // 端口映射格式：端口:指纹（支持混合格式，没有端口号的项属于前一个端口）
        portFpMap = {}
        lastPort = ""
        for item in items {
            item = str.TrimSpace(item)
            if item == "" {
                continue
            }
            if str.Contains(item, ":") {
                parts = str.Split(item, ":")
                if len(parts) >= 2 {
                    port = str.TrimSpace(parts[0])
                    fp = str.TrimSpace(parts[1])
                    // 检查第一部分是否为数字（端口）
                    if re.Match("^\\d+$", port) && fp != "" {
                        // 将同一端口的多个指纹合并
                        if port not in portFpMap {
                            portFpMap[port] = []
                        }
                        fps = portFpMap[port]
                        fps.Append(fp)
                        portFpMap[port] = fps
                        lastPort = port
                    }
                }
            } else {
                // 没有端口号的项，属于前一个端口
                if lastPort != "" {
                    if lastPort not in portFpMap {
                        portFpMap[lastPort] = []
                    }
                    fps = portFpMap[lastPort]
                    fps.Append(item)
                    portFpMap[lastPort] = fps
                }
            }
        }
        
        // 按端口分组查询并输出
        for port, fps in portFpMap {
            allPluginsForPort = []
            pluginNameMap = {}
            
            // 对每个指纹查询插件
            for fp in fps {
                plugins = queryFp(fp)
                for plugin in plugins {
                    pluginName = plugin["name"]
                    if pluginName not in pluginNameMap {
                        pluginNameMap[pluginName] = true
                        allPluginsForPort.Append(pluginName)
                    }
                }
            }
            
            // 输出格式：先输出汇总，再逐个输出插件名（避免截断）
            if len(allPluginsForPort) > 0 {
                yakit.Info("端口:%s  共找到 %d 个POC插件:", port, len(allPluginsForPort))
                // 每个插件名单独一行，方便复制
                for idx, pluginName in allPluginsForPort {
                    yakit.Info("  [%d] %s", idx+1, pluginName)
                }
                // 同时输出可直接复制的逗号分隔格式
                pluginNames = str.Join(allPluginsForPort, ",")
                yakit.Info("端口:%s  可复制格式: %s", port, pluginNames)
            } else {
                yakit.Info("端口:%s  poc插件:未找到", port)
            }
        }
    } else {
        // 简单格式：直接查询指纹
        names = str.Split(fpNames, ",")
        for name in names{
            name = str.TrimSpace(name)
            if name == "" {
                continue
            }
            plugins = queryFp(name)
            if len(plugins) > 0 {
                for plugin in plugins {
                    yakit.Info("插件名: %v, 插件介绍: %v", plugin["name"], plugin["desc"])
                }
            } else {
                yakit.Info("指纹 '%s' 未找到相关插件", name)
            }
        }
    }