# Manual Pentest 模块设计文档

## 设计时间
2026-02-02

## 一、设计概览

### 核心理念
- **主要测试方式**：AI 使用 curl/HTTP 请求直接测试
- **辅助工具**：仅在需要获取请求列表时调用 Yak crawler
- **测试策略**：基于分类式框架作为检查清单，AI 智能分析请求特征后灵活设计测试

### 执行流程
1. **目标确认** - 解析目标 URL/IP:端口
2. **登录/认证** - AI 尝试弱口令或使用用户提供的凭证，获取 Cookie/Token
3. **请求获取** - 如果有登录态，自动调用 Yak crawler 爬取请求列表；否则基于用户提供的 URL/数据包
4. **智能分析** - AI 分析每个请求的特征（URL、参数名、方法、Content-Type、业务含义）
5. **针对性测试** - 根据分析结果，灵活设计测试用例
6. **结果汇总** - 生成测试报告，区分已确认漏洞、疑似问题、未发现问题

---

## 二、漏洞测试框架（检查清单）

### 测试分类体系

框架按漏洞类型分为以下几大类，**作为检查清单提醒 AI 不要遗漏**，但具体如何测试由 AI 根据业务灵活决定：

**1. 认证类（Authentication）**
- 弱口令/默认凭证
- 登录绕过
- 会话固定
- 认证信息泄露
- 多因素认证绕过

**2. 授权类（Authorization）**
- 水平越权（访问同级别其他用户数据）
- 垂直越权（低权限访问高权限功能）
- 未授权访问（绕过登录直接访问）
- IDOR（不安全的直接对象引用）
- 权限提升

**3. 注入类（Injection）**
- SQL 注入
- 命令注入
- XPath 注入
- LDAP 注入
- NoSQL 注入

**4. 跨站类（Cross-Site）**
- XSS（反射型、存储型、DOM 型）
- CSRF
- 点击劫持

**5. 服务端请求类（Server-Side Request）**
- SSRF
- XXE
- SSTI（服务端模板注入）

**6. 文件操作类（File Operations）**
- 任意文件读取
- 任意文件上传
- 任意文件删除
- 路径穿越

**7. 业务逻辑类（Business Logic）**
- 金额/数量篡改
- 重放攻击
- 条件竞争
- 状态机绕过
- 优惠/折扣滥用

**8. 信息泄露类（Information Disclosure）**
- 敏感信息泄露（响应中）
- 错误信息泄露
- 源码泄露
- 目录遍历

---

## 三、安全防护机制

### 测试分级

**只读测试（默认执行，无需确认）**
- 水平/垂直越权读取
- 未授权访问
- 信息泄露检测
- 任意文件读取
- SQL/XSS/SSRF 注入检测（只读 payload）
- 密码爆破（限制次数，可能触发账号锁定）
- CSRF 测试
- 水平越权写入（修改其他同级用户的数据）

**写入测试（需用户确认）**
- 垂直越权写入（管理员操作）
- 文件上传/删除
- 数据篡改（金额、状态等）
- 命令注入执行
- SQL 注入写入
- 业务逻辑破坏

### 执行流程

**第一阶段：只读测试**
- AI 自动执行所有只读测试
- 实时输出测试进度和发现的问题
- 同时记录所有发现的"写入测试"机会

**第二阶段：写入测试确认（批量确认模式）**
- 只读测试完成后，AI 汇总展示：
  ```
  发现以下写入测试机会：
  [1] 文件上传 - /api/upload (可能允许上传任意文件)
  [2] 垂直越权 - /admin/users/delete (低权限可能删除用户)
  [3] 数据篡改 - /order/update (可能篡改订单金额)

  是否执行写入测试？(全部/选择编号/跳过)
  ```
- 用户选择后 AI 执行相应测试

**安全约束**
- 所有写入测试使用最小化 payload（如上传 1KB 测试文件）
- 尝试操作不存在的资源（如删除 ID=99999）
- 记录所有写入操作，便于事后回滚

---

## 四、AI 智能测试策略

### 核心理念

**不依赖模板化规则，而是让 AI 真正理解业务后灵活测试**

### AI 的分析过程

**第一步：深度理解请求**
- 分析 URL 路径、参数、方法理解**业务功能**
- 如果有 JS 文件，分析前端代码理解**接口用途**
- 查看响应内容理解**数据结构和业务逻辑**
- 推断这个接口在**完整业务流程中的位置**

**第二步：风险推理**

基于业务理解，AI 自主推理可能存在的安全问题：
- "这是个用户信息查询接口，可能存在越权"
- "这个接口返回文件内容，参数可能控制路径，可能任意文件读取"
- "这是订单创建接口，需要测试金额是否可篡改"
- "这个接口无需登录就能访问，但返回了敏感数据，可能未授权访问"

**第三步：设计测试用例**

AI 不是套用模板，而是针对具体场景**创造性地设计测试**：
- 根据业务逻辑构造异常输入
- 设计多步骤的攻击链（如先获取信息再利用）
- 结合多个接口进行组合测试
- 根据响应动态调整测试策略

### 测试示例

**接口示例**
```
POST /api/order/create
参数：{productId: 123, quantity: 1, price: 99.99}
响应：{orderId: 456, status: "pending", totalAmount: 99.99}
```

**Step 1: 深度理解**
```
AI 理解：
- 这是订单创建接口
- 前端传入了 price，后端可能直接使用
- 这是业务流程的起点，需要检查权限
```

**Step 2: 风险推理（跨多个分类思考）**
```
从业务逻辑类思考：
  → price 参数是否可篡改？尝试改成 0.01
  → quantity 是否有上限？尝试负数或超大值
  → 能否重复创建相同订单？测试幂等性

从授权类思考：
  → 是否需要登录？尝试无 Cookie 请求
  → 能否为他人创建订单？尝试修改 userId（如果有）

从注入类思考：
  → productId 可能查询数据库，测试 SQL 注入

从信息泄露类思考：
  → 响应是否泄露内部信息（如真实库存、成本价）
```

**Step 3: 灵活测试**
```bash
# 测试金额篡改
curl -X POST /api/order/create -d '{"productId":123,"quantity":1,"price":0.01}'

# 测试未授权
curl -X POST /api/order/create -d '{"productId":123,"quantity":1,"price":99.99}'  # 不带 Cookie

# 测试 SQL 注入
curl -X POST /api/order/create -d '{"productId":"123' OR '1'='1","quantity":1,"price":99.99}'

# 测试业务逻辑
curl -X POST /api/order/create -d '{"productId":123,"quantity":-1,"price":99.99}'
```

### 关键原则

- **理解优先**：先理解业务，再测试
- **跨分类思考**：一个接口可能涉及多个分类的安全问题
- **动态调整**：根据响应结果调整测试策略
- **组合攻击**：多个接口结合测试（如先获取管理员 token，再测试越权）
- **8 大分类是提醒，不是限制**：AI 可以发现分类外的问题

---

## 五、测试执行与报告

### 测试过程输出

AI 在测试时会实时输出分析思路，让用户了解测试逻辑：

```
[分析] /api/order/create - 订单创建接口
  业务理解：用户提交订单，包含商品ID、数量、价格

[风险推理]
  ✓ 业务逻辑：price 参数可能被篡改
  ✓ 授权：可能存在未授权创建订单
  ✓ 注入：productId 可能存在 SQL 注入

[测试] 金额篡改
  → 原始请求：price=99.99
  → 测试请求：price=0.01
  → 结果：✗ 订单创建成功，实际支付 0.01 元
  → 结论：存在金额篡改漏洞（业务逻辑类 - 写入测试）

[测试] 未授权访问
  → 移除 Cookie 后请求
  → 结果：✓ 返回 401 Unauthorized
  → 结论：权限校验正常

[测试] SQL 注入
  → Payload: productId="123' OR '1'='1"
  → 结果：✓ 返回 400 参数错误
  → 结论：未发现明显注入点
```

### 最终报告格式

```markdown
# 渗透测试报告

## 目标信息
- URL: http://example.com:8080
- 测试时间: 2026-02-02 14:30
- 登录状态: 已登录（user role）

## 发现的问题

### 高危 (2)

**[业务逻辑] 订单金额篡改**
- 接口: POST /api/order/create
- 描述: price 参数未在服务端验证，可随意修改订单金额
- 复现步骤:
  1. 正常创建订单，price=99.99
  2. 修改 price=0.01，订单仍创建成功
  3. 实际支付金额为 0.01
- 影响: 可以 0 元购买商品
- 测试类型: 写入测试

**[授权] 垂直越权删除用户**
- 接口: DELETE /admin/users/{id}
- 描述: 普通用户可访问管理员删除接口
- 复现步骤:
  1. 使用普通用户 Cookie
  2. DELETE /admin/users/999（不存在的ID）
  3. 返回 404 Not Found（说明通过了权限检查）
- 影响: 普通用户可能删除其他用户
- 测试类型: 写入测试（已使用不存在ID）

### 中危 (3)

**[授权] 水平越权读取**
- 接口: GET /api/user/profile?id=123
- 描述: 可查看其他用户的个人信息
- 复现: 修改 id 参数查看他人信息
- 测试类型: 只读测试

**[信息泄露] 敏感信息泄露**
- 接口: GET /api/config
- 描述: 响应中包含数据库连接字符串
- 测试类型: 只读测试

**[文件操作] 任意文件读取**
- 接口: GET /download?file=report.pdf
- 描述: file 参数可穿越目录
- 复现: file=../../etc/passwd 返回文件内容
- 测试类型: 只读测试

### 低危 (1)

**[信息泄露] 详细错误信息**
- 多个接口在错误时返回详细堆栈信息
- 测试类型: 只读测试

## 未发现问题的测试

- SQL 注入：测试 8 个接口，未发现注入点
- XSS：测试 5 个输入点，均有转义
- CSRF：所有写入接口均有 token 校验
- 命令注入：无相关接口
- XXE：无 XML 处理接口

## 待确认的写入测试 (0)

所有写入测试已在用户确认后执行完毕。

## 统计
- 总测试接口: 23
- 发现问题: 6
- 只读测试: 18
- 写入测试: 5（用户已确认）
```

---

## 六、与原设计的对比

### 主要变更

1. **去除 Yak 脚本依赖**
   - 原设计：AI 判断是否使用 Yak 脚本进行漏洞检测
   - 新设计：完全使用 curl/HTTP 请求，AI 灵活设计测试

2. **从模板化到智能化**
   - 原设计：基于参数名特征匹配对应脚本
   - 新设计：AI 深度理解业务后创造性设计测试用例

3. **保留 crawler 作为辅助**
   - 有登录态时自动调用 Yak crawler 获取请求列表
   - 但测试阶段完全不依赖 Yak

4. **增强安全防护**
   - 分级测试机制（只读/写入）
   - 批量确认模式避免频繁打断

### 优势

- **灵活性**：AI 不受模板限制，可以针对特定业务设计测试
- **智能性**：充分发挥 AI 的理解能力和创造性
- **安全性**：分级测试机制保护生产环境
- **简洁性**：减少对 Yak 工具链的依赖

---

## 七、实施建议

### 下一步工作

1. **重写 SKILL.md**
   - 移除 Yak 脚本相关内容
   - 加入 AI 智能测试策略说明
   - 添加安全防护机制描述

2. **提供测试示例**
   - 在 skill 中提供几个完整的测试案例
   - 展示 AI 如何从理解到测试的完整过程

3. **优化提示词**
   - 强调"理解业务"的重要性
   - 提醒 AI 使用 8 大分类作为检查清单
   - 明确安全约束（只读/写入测试）

### 注意事项

- AI 需要较强的业务理解能力
- 需要明确告知 AI 不要机械套用规则
- 建议在 skill 中提供详细的测试思路示例
