---
name: manual-pentest
description: AI 驱动的智能渗透测试，基于业务理解灵活设计测试用例，主要使用 curl/HTTP 请求，可选调用 Yak crawler 获取请求列表
---

# 手动渗透（AI 智能测试）

## 一、触发条件

当用户输入以下任意一种时，进入「手动渗透」流程：

- 「手动测试 \<目标\>」
- 「手动渗透 \<目标\>」
- 「AI 接管渗透 \<目标\>」

\<目标\> 可为 URL（如 `http://192.168.3.24:8080`）或 IP:端口。

---

## 二、执行流程

### 2.1 目标确认
解析目标 URL/IP:端口，使用 curl 探活确认目标可访问。

### 2.2 登录/认证
- AI 尝试弱口令登录（常见用户名密码组合）
- 或使用用户提供的凭证
- 成功后提取 Cookie/Token 用于后续测试

### 2.3 请求获取

**有登录态时**：自动调用 Yak crawler 爬取请求列表
```bash
cd "<SKILL_BASE_DIR>/../auto-pentest" && yak tools/crawler/crawler.yak --targetUrl <URL> --cookie "<COOKIE>"
```

**用户已提供请求/数据包时**：直接基于现有请求分析，无需爬虫

### 2.4 智能分析与测试

**核心理念**：AI 不是机械套用规则，而是深度理解业务后灵活设计测试

#### 分析过程

**Step 1: 深度理解请求**
- 分析 URL 路径、参数、方法理解**业务功能**
- 如果有 JS 文件，分析前端代码理解**接口用途**
- 查看响应内容理解**数据结构和业务逻辑**
- 推断这个接口在**完整业务流程中的位置**

**Step 2: 风险推理**
基于业务理解，从 8 大安全分类思考可能存在的问题：
1. **认证类**：弱口令、登录绕过、会话固定等
2. **授权类**：水平越权、垂直越权、未授权访问、IDOR 等
3. **注入类**：SQL 注入、命令注入、XPath 注入、NoSQL 注入等
4. **跨站类**：XSS、CSRF、点击劫持等
5. **服务端请求类**：SSRF、XXE、SSTI 等
6. **文件操作类**：任意文件读取、文件上传、文件删除、路径穿越等
7. **业务逻辑类**：金额篡改、条件竞争、状态机绕过、重放攻击等
8. **信息泄露类**：敏感信息、错误信息、源码泄露等

**注意**：8 大分类是**检查清单**，提醒 AI 不要遗漏，但不是机械套用模板。一个接口可能涉及多个分类，AI 需要跨分类思考。

**Step 3: 设计测试用例**
基于风险推理，AI 创造性地设计测试用例：
- 根据业务逻辑构造异常输入
- 设计多步骤的攻击链
- 结合多个接口进行组合测试
- 根据响应动态调整测试策略

#### 测试示例

```
接口：POST /api/order/create
参数：{productId: 123, quantity: 1, price: 99.99}
响应：{orderId: 456, status: "pending", totalAmount: 99.99}

[理解] 这是订单创建接口，前端传入了 price，后端可能直接使用

[风险推理]
从业务逻辑类思考：
  → price 参数是否可篡改？尝试改成 0.01
  → quantity 是否有上限？尝试负数或超大值

从授权类思考：
  → 是否需要登录？尝试无 Cookie 请求
  → 能否为他人创建订单？

从注入类思考：
  → productId 可能查询数据库，测试 SQL 注入

[测试]
curl -X POST /api/order/create -d '{"productId":123,"quantity":1,"price":0.01}'
curl -X POST /api/order/create -d '{"productId":123,"quantity":1,"price":99.99}'  # 不带 Cookie
curl -X POST /api/order/create -d '{"productId":"123' OR '1'='1","quantity":1,"price":99.99}'
```

### 2.5 安全防护机制

**分级测试策略**

#### 只读测试（默认执行，无需确认）
- 水平/垂直越权读取
- 未授权访问
- 信息泄露检测
- 任意文件读取
- SQL/XSS/SSRF 注入检测（只读 payload）
- 密码爆破（限制次数）
- CSRF 测试
- 水平越权写入

#### 写入测试（需用户确认）
- 垂直越权写入（管理员操作）
- 文件上传/删除
- 数据篡改（金额、状态等）
- 命令注入执行
- SQL 注入写入
- 业务逻辑破坏

**执行流程**

1. **第一阶段：只读测试**
   - AI 自动执行所有只读测试
   - 实时输出测试进度和发现的问题
   - 同时记录所有发现的"写入测试"机会

2. **第二阶段：批量确认**
   - 只读测试完成后，AI 汇总展示所有写入测试机会
   - 用户可选择：全部执行 / 选择编号执行 / 跳过
   - AI 根据用户选择执行相应测试

**安全约束**
- 所有写入测试使用最小化 payload（如上传 1KB 测试文件）
- 尝试操作不存在的资源（如删除 ID=99999）
- 记录所有写入操作

### 2.6 测试报告

实时输出测试过程，最终生成完整报告：

```
[分析] /api/order/create - 订单创建接口
  业务理解：用户提交订单，包含商品ID、数量、价格

[风险推理]
  ✓ 业务逻辑：price 参数可能被篡改
  ✓ 授权：可能存在未授权创建订单
  ✓ 注入：productId 可能存在 SQL 注入

[测试] 金额篡改
  → 原始请求：price=99.99
  → 测试请求：price=0.01
  → 结果：✗ 订单创建成功，实际支付 0.01 元
  → 结论：存在金额篡改漏洞（业务逻辑类 - 写入测试）

[测试] 未授权访问
  → 移除 Cookie 后请求
  → 结果：✓ 返回 401 Unauthorized
  → 结论：权限校验正常
```

**最终报告包含**：
- 目标信息
- 发现的问题（按高/中/低危分类）
- **每个漏洞的完整 HTTP 请求数据包**（方便在 Yakit 中直接复现）
- 每个问题的详细复现步骤
- 未发现问题的测试项
- 待确认的写入测试
- 统计信息

**重要**：对于每个确认存在的漏洞，必须输出完整的 HTTP 请求数据包，包括：
- 请求行（方法、路径、协议版本）
- 完整的请求头（Host、Cookie、User-Agent、Content-Type 等）
- 请求体（如果是 POST/PUT）
- 并标注："漏洞确定存在，可直接在 Yakit 中发包来查看此漏洞！当前漏洞数据包为："

---

## 三、关键原则

1. **理解优先**：先深度理解业务，再设计测试
2. **跨分类思考**：一个接口可能涉及多个安全分类
3. **动态调整**：根据响应结果调整测试策略
4. **组合攻击**：多个接口结合测试
5. **灵活设计**：不机械套用规则，根据实际场景创造性设计测试
6. **8 大分类是提醒，不是限制**：可以发现分类外的问题

---

## 四、工具使用说明

### 4.1 主要测试工具：curl

所有测试主要使用 **curl/HTTP 请求**，AI 根据业务逻辑灵活构造请求。

### 4.2 辅助工具：Yak crawler

**仅用于获取请求列表**，位于 `<SKILL_BASE_DIR>/../auto-pentest/tools/crawler/`

有登录态时自动调用：
```bash
cd "<SKILL_BASE_DIR>/../auto-pentest" && yak tools/crawler/crawler.yak --targetUrl <URL> --cookie "<COOKIE>"
```

### 4.3 不再使用 Yak 漏洞检测脚本

原设计中的 `script/*.yak` 漏洞检测脚本**不再使用**，所有漏洞测试由 AI 使用 curl 灵活完成。

---

## 五、测试报告模板

```markdown
# 渗透测试报告

## 目标信息
- URL: http://example.com:8080
- 测试时间: 2026-02-02 14:30
- 登录状态: 已登录（user role）

## 发现的问题

### 高危 (2)

**[业务逻辑] 订单金额篡改**
- 接口: POST /api/order/create
- 描述: price 参数未在服务端验证，可随意修改订单金额
- 复现步骤:
  1. 正常创建订单，price=99.99
  2. 修改 price=0.01，订单仍创建成功
  3. 实际支付金额为 0.01
- 影响: 可以 0 元购买商品
- 测试类型: 写入测试
- **漏洞确定存在，可直接在 Yakit 中发包来查看此漏洞！当前漏洞数据包为：**
```http
POST /api/order/create HTTP/1.1
Host: example.com:8080
Content-Type: application/json
Cookie: session=abc123def456
Content-Length: 58

{"productId":123,"quantity":1,"price":0.01}
```

**[授权] 垂直越权删除用户**
- 接口: DELETE /admin/users/{id}
- 描述: 普通用户可访问管理员删除接口
- 复现步骤:
  1. 使用普通用户 Cookie
  2. DELETE /admin/users/999（不存在的ID）
  3. 返回 404 Not Found（说明通过了权限检查）
- 影响: 普通用户可能删除其他用户
- 测试类型: 写入测试（已使用不存在ID）
- **漏洞确定存在，可直接在 Yakit 中发包来查看此漏洞！当前漏洞数据包为：**
```http
DELETE /admin/users/999 HTTP/1.1
Host: example.com:8080
Cookie: session=user_token_low_privilege
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:147.0) Gecko/20100101 Firefox/147.0
Accept: application/json
```

### 中危 (3)

**[授权] 水平越权读取**
- 接口: GET /api/user/profile?id=123
- 描述: 可查看其他用户的个人信息
- 复现: 修改 id 参数查看他人信息
- 测试类型: 只读测试
- **漏洞确定存在，可直接在 Yakit 中发包来查看此漏洞！当前漏洞数据包为：**
```http
GET /api/user/profile?id=456 HTTP/1.1
Host: example.com:8080
Cookie: session=user123_token
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:147.0) Gecko/20100101 Firefox/147.0
Accept: application/json
```

**[信息泄露] 敏感信息泄露**
- 接口: GET /api/config
- 描述: 响应中包含数据库连接字符串
- 测试类型: 只读测试
- **漏洞确定存在，可直接在 Yakit 中发包来查看此漏洞！当前漏洞数据包为：**
```http
GET /api/config HTTP/1.1
Host: example.com:8080
Accept: application/json
```

**[文件操作] 任意文件读取**
- 接口: GET /download?file=report.pdf
- 描述: file 参数可穿越目录
- 复现: file=../../etc/passwd 返回文件内容
- 测试类型: 只读测试
- **漏洞确定存在，可直接在 Yakit 中发包来查看此漏洞！当前漏洞数据包为：**
```http
GET /download?file=../../etc/passwd HTTP/1.1
Host: example.com:8080
Cookie: session=user_session
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:147.0) Gecko/20100101 Firefox/147.0
Accept: */*
```

### 低危 (1)

**[信息泄露] 详细错误信息**
- 多个接口在错误时返回详细堆栈信息
- 测试类型: 只读测试

## 未发现问题的测试

- SQL 注入：测试 8 个接口，未发现注入点
- XSS：测试 5 个输入点，均有转义
- CSRF：所有写入接口均有 token 校验
- 命令注入：无相关接口
- XXE：无 XML 处理接口

## 待确认的写入测试 (0)

所有写入测试已在用户确认后执行完毕。

## 统计
- 总测试接口: 23
- 发现问题: 6
- 只读测试: 18
- 写入测试: 5（用户已确认）
```
