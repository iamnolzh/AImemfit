# Manual Pentest Skill 设计文档

**日期**: 2026-01-30
**作者**: AI Brainstorming Session
**版本**: 1.0

---

## 1. 设计目标

创建一个 AI 完全接管的手动渗透测试 skill，模拟真实渗透测试者的行为流程，深度测试小型站点的业务逻辑和权限控制漏洞。

### 核心理念
- **AI 是"大脑"** - 决策测试策略和目标
- **Yak 是"手脚"** - 执行 HTTP 请求和数据管理
- **HTTPFlow 是"记忆"** - 保存所有请求供后续分析

---

## 2. 关键设计决策

### 2.1 Yak 参与方式 (选择 A + C)

**A) 请求发送 - 使用 poc.HTTP()**
- 替代 curl/axios 等工具
- 利用 Yak 的连接池、重试机制、超时控制
- 统一请求接口，便于后续扩展

**C) HTTPFlow 管理 - 每个请求保存到数据库**
```yak
yakit.SaveHTTPFlowFromRawWithOption(url, req, resp,
    yakit.saveHTTPFlowWithTags("manual,recon"))
```
- 所有请求自动归档
- 打标签便于分类查询
- 可在 Yakit GUI 中查看详情
- 支持后续调用 yak 脚本深度检测

### 2.2 测试流程 (选择 C - 模拟真实渗透者)

```
侦察 → 寻找入口点 → 获取立足点 → 横向/纵向测试 → 漏洞挖掘 → 敏感数据
```

这个流程符合 PTES (Penetration Testing Execution Standard) 的思路。

### 2.3 认证处理 (选择 D - 混合方式)

- **简单表单登录**: AI 用 poc.HTTP() 直接处理
- **复杂认证** (CSRF/OAuth): 调用 session_manager.yak 工具脚本

### 2.4 输出格式 (选择 D - 分层报告)

- **实时日志**: 边测边输出关键发现 (用户看到进度)
- **最终报告**: 完整 .md 文件 (便于存档和分享)

---

## 3. 技术架构

### 3.1 文件结构

```
manual-pentest/
├── SKILL.md                    # 主 skill 文档 (AI 执行指南)
├── skill.json                  # 元信息 + 触发词
├── tools/
│   └── session_manager.yak     # 复杂认证处理
├── templates/
│   ├── weak_passwords.txt      # 弱口令字典
│   └── sensitive_paths.txt     # 敏感路径列表
└── reports/                    # 报告输出目录
```

### 3.2 核心 API 使用

```yak
// 发送 GET 请求
req, _ = poc.ParseUrlToHTTPRequestRaw("GET", url)
resp, _, err = poc.HTTP(req,
    poc.https(isHttps),
    poc.connTimeout(10),
    poc.retry(3))

// 发送 POST 请求
req = poc.BasicRequest()
req = poc.ReplaceHTTPPacketFirstLine(req, "POST", path, "HTTP/1.1")
req = poc.AppendHTTPPacketHeader(req, "Content-Type", "application/x-www-form-urlencoded")
req = poc.AppendHTTPPacketBody(req, []byte(postBody), false)
resp, _, _ = poc.HTTP(req, poc.https(isHttps))

// 保存到 HTTPFlow
yakit.SaveHTTPFlowFromRawWithOption(url, req, resp,
    yakit.saveHTTPFlowWithTags("manual,stage-name"))

// 查询 HTTPFlow
flows = db.QueryHTTPFlowsByKeyword("manual")
flow = db.QueryHTTPFlowsByID(12345)
```

---

## 4. 执行流程详解

### 阶段0: 目标侦察
- 访问首页 → 识别技术栈
- 探测敏感路径 (robots.txt, /admin, /.git 等)
- **标签**: `manual,recon`

### 阶段1: 寻找入口点
- 识别登录页 (提取表单字段)
- 识别 API 端点
- 识别文件上传点
- **标签**: `manual,entry`

### 阶段2: 获取立足点
- 简单登录 → poc.HTTP() 尝试弱口令
- 复杂认证 → 调用 session_manager.yak
- **标签**: `manual,login`

### 阶段3: 横向/纵向测试
- 带 Cookie 访问受保护资源
- 测试越权 (修改 id 参数)
- 测试提权 (访问管理员功能)
- **标签**: `manual,auth-test`

### 阶段4: 深度漏洞挖掘
- 快速测试 XSS/SQLi/SSRF
- 对疑似点调用现有 yak 脚本 (xss.yak 等)
- 测试文件上传漏洞
- **标签**: `manual,xss-test`, `manual,sqli-test`

### 阶段5: 敏感数据挖掘
- 测试信息泄露 (/.env, /.git, /backup.sql)
- 在响应中搜索敏感信息 (密码/IP/邮箱)
- **标签**: `manual,sensitive`

### 阶段6: 生成报告
- 汇总所有发现
- 生成 .md 文件到 reports/
- 输出 HTTPFlow 查询方法

---

## 5. 与 auto-pentest 的对比

| 维度 | auto-pentest | manual-pentest |
|------|--------------|----------------|
| 测试方式 | 爬虫 + 批量脚本 | 逐步深入 + 业务逻辑 |
| 请求发送 | crawlerx | **poc.HTTP()** |
| 适用场景 | 大范围扫描 | **小型站点深度测试** |
| 时间消耗 | 10-30 分钟 | 15-45 分钟 |
| HTTPFlow | 自动保存 | **手动保存 + 打标签** |
| 测试深度 | 表层漏洞 | **业务逻辑 + 权限** |

**建议工作流**:
1. 先跑 auto-pentest 快速扫描
2. 对重点目标跑 manual-pentest 深度测试

---

## 6. 关键创新点

### 6.1 HTTPFlow 标签系统
- 每个请求打标签: `manual,<stage>,<detail>`
- 便于分阶段查询和分析
- 可在 Yakit GUI 中过滤查看

### 6.2 混合认证策略
- 简单场景 AI 直接处理 (效率高)
- 复杂场景调用工具脚本 (灵活性)

### 6.3 分层报告
- 实时日志 (用户看到进度，不焦虑)
- 最终报告 (完整归档，便于分享)

### 6.4 漏洞检测分级
- 快速测试 (AI 自己实现，几秒钟)
- 深度检测 (调用 yak 脚本，几分钟)

---

## 7. 实现注意事项

### 7.1 必须遵守的约束
1. **不询问确认** - 看到触发词立即执行
2. **连续执行** - 所有阶段一次性完成
3. **HTTPFlow 保存** - 每个请求都要保存
4. **工作目录** - 先 cd 到 SKILL_BASE_DIR
5. **敏感操作** - 发现越权等漏洞仅报告不利用

### 7.2 错误处理
- 某阶段失败不中断流程
- 输出警告后继续下一阶段
- 最终报告中标注失败的阶段

### 7.3 性能优化
- 超时设置: 单个请求 10 秒
- 并发控制: 顺序执行各阶段 (避免触发 WAF)
- 请求间隔: 可选参数 (默认无间隔)

---

## 8. 未来扩展方向

### 8.1 短期 (v1.1)
- 添加 reconnaissance.yak 工具脚本 (可选)
- 支持自定义弱口令字典
- 支持代理设置

### 8.2 中期 (v1.2)
- 支持多目标批量测试
- 集成机器学习模型预测漏洞点
- 生成 HTML 报告 (带图表)

### 8.3 长期 (v2.0)
- 自适应测试策略 (根据响应动态调整)
- 分布式测试 (多节点协同)
- 与 auto-pentest 智能联动

---

## 9. 测试验证

### 9.1 基本功能测试
- [ ] 触发词正确启动
- [ ] 各阶段顺序执行
- [ ] HTTPFlow 正确保存和打标签
- [ ] 报告正确生成

### 9.2 场景测试
- [ ] DVWA (简单表单登录)
- [ ] 需要 CSRF token 的站点
- [ ] 含越权漏洞的站点
- [ ] 含 XSS/SQLi 的站点
- [ ] 有敏感文件泄露的站点

### 9.3 压力测试
- [ ] 大型站点 (100+ 页面)
- [ ] 慢速响应站点
- [ ] 多重定向场景

---

## 10. 文档与培训

### 10.1 用户文档
- SKILL.md (技术文档，给 AI 看)
- README.md (用户指南，给人看)

### 10.2 示例
- 提供 DVWA 测试示例
- 提供常见问题排查

---

## 11. 总结

这个设计方案实现了:
1. ✅ AI 完全接管 (不需要用户交互)
2. ✅ Yak 深度参与 (poc.HTTP + HTTPFlow)
3. ✅ 模拟真实渗透者 (6 阶段流程)
4. ✅ 适用小型站点深度测试
5. ✅ 与 auto-pentest 互补

核心价值:
- **对于用户**: 一句话深度测试，自动发现业务逻辑漏洞
- **对于 Yak 生态**: 展示 poc.HTTP 和 HTTPFlow 的强大能力
- **对于渗透测试**: 提供可复现、可追溯的测试流程

---

**设计完成时间**: 2026-01-30
**预计开发时间**: 2-3 天
**预计测试时间**: 1-2 天
