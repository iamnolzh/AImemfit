name: Build and Release

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag (e.g. v1.1.6)'
        required: true
        default: 'v1.1.6'

env:
  BUN_VERSION: '1.3.8'

jobs:
  fetch-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}
      tag: ${{ steps.get-version.outputs.tag }}
    steps:
      - name: Get version and tag
        id: get-version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            TAG="${{ inputs.release_tag }}"
          else
            TAG="${{ github.ref_name }}"
          fi
          VERSION=$(echo "$TAG" | sed 's/^v//' | sed 's/-.*$//')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Building Yaklang (this repo) version: $VERSION tag: $TAG"

  # Build Linux CLI from this repo
  build-linux:
    needs: fetch-version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install Dependencies
        run: bun install

      - name: Build Linux CLI (this repo)
        run: cd packages/yaklang && bun run build
        env:
          YAKLANG_VERSION: ${{ needs.fetch-version.outputs.version }}
          YAKLANG_CHANNEL: latest

      - name: Upload Linux x64
        uses: actions/upload-artifact@v4
        with:
          name: yaklang-linux-x64
          path: packages/yaklang/dist/yaklang-linux-x64/bin/yaklang
          retention-days: 5

      - name: Upload Linux x64 baseline
        uses: actions/upload-artifact@v4
        with:
          name: yaklang-linux-x64-baseline
          path: packages/yaklang/dist/yaklang-linux-x64-baseline/bin/yaklang
          retention-days: 5
          if-no-files-found: ignore

      - name: Upload Linux ARM64
        uses: actions/upload-artifact@v4
        with:
          name: yaklang-linux-arm64
          path: packages/yaklang/dist/yaklang-linux-arm64/bin/yaklang
          retention-days: 5

      - name: Upload Linux ARM64 musl
        uses: actions/upload-artifact@v4
        with:
          name: yaklang-linux-arm64-musl
          path: packages/yaklang/dist/yaklang-linux-arm64-musl/bin/yaklang
          retention-days: 5
          if-no-files-found: ignore

  # Build Windows CLI from this repo
  build-windows:
    needs: fetch-version
    runs-on: windows-latest
    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install Dependencies
        run: bun install
        shell: bash

      - name: Build Windows CLI (this repo)
        run: cd packages/yaklang && bun run build --single
        shell: bash
        env:
          YAKLANG_VERSION: ${{ needs.fetch-version.outputs.version }}
          YAKLANG_CHANNEL: latest

      - name: Upload Windows x64
        uses: actions/upload-artifact@v4
        with:
          name: yaklang-windows-x64
          path: packages/yaklang/dist/yaklang-windows-x64/bin/yaklang.exe
          retention-days: 5

      - name: Upload Windows x64 baseline
        uses: actions/upload-artifact@v4
        with:
          name: yaklang-windows-x64-baseline
          path: packages/yaklang/dist/yaklang-windows-x64-baseline/bin/yaklang.exe
          retention-days: 5
          if-no-files-found: ignore

  # Build macOS CLI from this repo
  build-macos:
    needs: fetch-version
    runs-on: macos-latest
    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install Dependencies
        run: bun install

      - name: Build macOS CLI (this repo)
        run: cd packages/yaklang && bun run build
        env:
          YAKLANG_VERSION: ${{ needs.fetch-version.outputs.version }}
          YAKLANG_CHANNEL: latest

      - name: Upload macOS ARM64
        uses: actions/upload-artifact@v4
        with:
          name: yaklang-darwin-arm64
          path: packages/yaklang/dist/yaklang-darwin-arm64/bin/yaklang
          retention-days: 5

      - name: Upload macOS x64
        uses: actions/upload-artifact@v4
        with:
          name: yaklang-darwin-x64
          path: packages/yaklang/dist/yaklang-darwin-x64/bin/yaklang
          retention-days: 5

  # Build Desktop (Tauri) from this repo
  build-desktop:
    needs: [fetch-version, build-linux, build-macos, build-windows]
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            target: aarch64-apple-darwin
            cli-artifact: yaklang-darwin-arm64
            desktop-name: yaklang-desktop-darwin-arm64
          - os: macos-latest
            target: x86_64-apple-darwin
            cli-artifact: yaklang-darwin-x64
            desktop-name: yaklang-desktop-darwin-x64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            cli-artifact: yaklang-windows-x64
            desktop-name: yaklang-desktop-windows-x64
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            cli-artifact: yaklang-linux-x64
            desktop-name: yaklang-desktop-linux-x64
          - os: ubuntu-24.04-arm
            target: aarch64-unknown-linux-gnu
            cli-artifact: yaklang-linux-arm64
            desktop-name: yaklang-desktop-linux-arm64
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4

      - name: Download CLI artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.cli-artifact }}
          path: cli-binary

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install dependencies (Ubuntu)
        if: contains(matrix.os, 'ubuntu')
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          # Install create-dmg for DMG bundling
          brew install create-dmg

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: packages/desktop/src-tauri
          shared-key: ${{ matrix.target }}

      # Fixes AppImage build issues on Linux
      - name: Install tauri-cli from portable appimage branch
        if: contains(matrix.os, 'ubuntu')
        run: |
          cargo install tauri-cli --git https://github.com/tauri-apps/tauri --branch feat/truly-portable-appimage --force
          echo "Installed tauri-cli version:"
          cargo tauri --version

      - name: Install dependencies
        run: bun install
        shell: bash

      - name: Prepare sidecar binary
        run: |
          cd packages/desktop
          if [ "${{ runner.os }}" == "Windows" ]; then
            cp ../../cli-binary/yaklang.exe "src-tauri/yaklang-cli-${{ matrix.target }}.exe"
          else
            cp ../../cli-binary/yaklang "src-tauri/yaklang-cli-${{ matrix.target }}"
            chmod +x "src-tauri/yaklang-cli-${{ matrix.target }}"
          fi
          ls -la src-tauri/
        shell: bash

      - name: Update Tauri config version
        run: |
          cd packages/desktop
          VERSION="${{ needs.fetch-version.outputs.version }}"
          if [ "${{ runner.os }}" == "Windows" ]; then
            sed -i "s/\"version\": \"[^\"]*\"/\"version\": \"$VERSION\"/" src-tauri/tauri.conf.json
          else
            sed -i '' "s/\"version\": \"[^\"]*\"/\"version\": \"$VERSION\"/" src-tauri/tauri.conf.json 2>/dev/null || \
            sed -i "s/\"version\": \"[^\"]*\"/\"version\": \"$VERSION\"/" src-tauri/tauri.conf.json
          fi
        shell: bash

      - name: Disable updater in prod config (no signing key)
        run: |
          cd packages/desktop
          # Create a modified prod config without updater
          cat > src-tauri/tauri.prod.conf.json << 'EOF'
          {
            "$schema": "https://schema.tauri.app/config/2",
            "productName": "yaklang",
            "identifier": "ai.yaklang.desktop",
            "bundle": {
              "externalBin": ["yaklang-cli"],
              "createUpdaterArtifacts": false,
              "icon": [
                "icons/prod/32x32.png",
                "icons/prod/128x128.png",
                "icons/prod/128x128@2x.png",
                "icons/prod/icon.icns",
                "icons/prod/icon.ico"
              ],
              "windows": {
                "nsis": {
                  "installerIcon": "icons/prod/icon.ico"
                }
              }
            }
          }
          EOF
          cat src-tauri/tauri.prod.conf.json
        shell: bash

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          projectPath: packages/desktop
          tauriScript: ${{ contains(matrix.os, 'ubuntu') && 'cargo tauri' || '' }}
          args: --target ${{ matrix.target }} --config src-tauri/tauri.prod.conf.json

      - name: Upload Desktop artifacts (macOS)
        if: runner.os == 'macOS'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.desktop-name }}
          path: |
            packages/desktop/src-tauri/target/${{ matrix.target }}/release/bundle/dmg/*.dmg
          retention-days: 5
          if-no-files-found: ignore

      - name: Upload Desktop artifacts (Windows)
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.desktop-name }}
          path: |
            packages/desktop/src-tauri/target/${{ matrix.target }}/release/bundle/msi/*.msi
            packages/desktop/src-tauri/target/${{ matrix.target }}/release/bundle/nsis/*.exe
          retention-days: 5
          if-no-files-found: ignore

      - name: Upload Desktop artifacts (Linux)
        if: contains(matrix.os, 'ubuntu')
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.desktop-name }}
          path: |
            packages/desktop/src-tauri/target/${{ matrix.target }}/release/bundle/appimage/*.AppImage
            packages/desktop/src-tauri/target/${{ matrix.target }}/release/bundle/deb/*.deb
          retention-days: 5
          if-no-files-found: ignore

  release:
    needs: [fetch-version, build-linux, build-macos, build-windows, build-desktop]
    if: always() && needs.build-linux.result == 'success' && needs.build-macos.result == 'success' && needs.build-windows.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repo (for .yaklang skills)
        uses: actions/checkout@v4
        with:
          path: repo
          lfs: true

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare Release Files
        run: |
          mkdir -p release

          # Show what was downloaded
          echo "Downloaded artifacts:"
          find artifacts -type f | head -50

          # Rename and organize CLI files
          for dir in artifacts/*/; do
            dirname=$(basename "$dir")

            # Handle CLI artifacts (files directly in directory)
            for file in "$dir"*; do
              if [ -f "$file" ]; then
                case "$dirname" in
                  yaklang-linux-x64)
                    cp "$file" "release/yaklang-linux-x64"
                    ;;
                  yaklang-linux-x64-baseline)
                    cp "$file" "release/yaklang-linux-x64-baseline"
                    ;;
                  yaklang-linux-arm64)
                    cp "$file" "release/yaklang-linux-arm64"
                    ;;
                  yaklang-linux-arm64-musl)
                    cp "$file" "release/yaklang-linux-arm64-musl"
                    ;;
                  yaklang-darwin-arm64)
                    cp "$file" "release/yaklang-darwin-arm64"
                    ;;
                  yaklang-darwin-x64)
                    cp "$file" "release/yaklang-darwin-x64"
                    ;;
                  yaklang-windows-x64)
                    cp "$file" "release/yaklang-windows-x64.exe"
                    ;;
                  yaklang-windows-x64-baseline)
                    cp "$file" "release/yaklang-windows-x64-baseline.exe"
                    ;;
                esac
              fi
            done

            # Handle Desktop artifacts (files in nested directories)
            if [[ "$dirname" == yaklang-desktop-* ]]; then
              # Find and copy DMG files (macOS)
              find "$dir" -name "*.dmg" -type f | while read -r file; do
                filename=$(basename "$file")
                echo "Copying DMG: $filename"
                cp "$file" "release/$filename"
              done

              # Find and copy MSI files (Windows)
              find "$dir" -name "*.msi" -type f | while read -r file; do
                filename=$(basename "$file")
                echo "Copying MSI: $filename"
                cp "$file" "release/$filename"
              done

              # Find and copy NSIS exe files (Windows installer)
              find "$dir" -path "*/nsis/*.exe" -type f | while read -r file; do
                filename=$(basename "$file")
                echo "Copying NSIS EXE: $filename"
                cp "$file" "release/$filename"
              done

              # Find and copy AppImage files (Linux)
              find "$dir" -name "*.AppImage" -type f | while read -r file; do
                filename=$(basename "$file")
                echo "Copying AppImage: $filename"
                cp "$file" "release/$filename"
              done

              # Find and copy deb files (Linux)
              find "$dir" -name "*.deb" -type f | while read -r file; do
                filename=$(basename "$file")
                echo "Copying DEB: $filename"
                cp "$file" "release/$filename"
              done
            fi
          done

          chmod +x release/yaklang-* 2>/dev/null || true

          # Bundle .yaklang/skill for users (auto-pentest etc., yak_fast via LFS)
          if [ -d repo/.yaklang ]; then
            (cd repo && zip -r ../release/yaklang-skills.zip .yaklang -x "*.git*")
            echo "Added yaklang-skills.zip (contains .yaklang/skill including yak_fast)"
          fi

          echo ""
          echo "Final release files:"
          ls -la release/

      - name: Generate Checksums
        run: |
          cd release
          sha256sum * > checksums.sha256
          cat checksums.sha256

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.fetch-version.outputs.tag }}
          name: Yaklang ${{ needs.fetch-version.outputs.tag }}
          body: |
            ## Yaklang Release (this repo)

            Built from this repository — CLI, Desktop, and prompts are all from our own code.

            ### CLI Downloads

            | Platform | Architecture | File |
            |----------|--------------|------|
            | Linux | x64 | `yaklang-linux-x64` |
            | Linux | x64 (baseline) | `yaklang-linux-x64-baseline` |
            | Linux | ARM64 | `yaklang-linux-arm64` |
            | macOS | Apple Silicon | `yaklang-darwin-arm64` |
            | macOS | Intel | `yaklang-darwin-x64` |
            | Windows | x64 | `yaklang-windows-x64.exe` |

            ### Skills (auto-pentest, etc.)

            Download `yaklang-skills.zip` and extract `.yaklang` to your home or project:

            ```bash
            curl -L -o yaklang-skills.zip https://github.com/${{ github.repository }}/releases/download/${{ needs.fetch-version.outputs.tag }}/yaklang-skills.zip
            unzip yaklang-skills.zip -d ~  # or: unzip -d /path/to/your/project
            ```
            Or place `.yaklang` in your project root so yaklang loads skills when run from that directory.

            ### Desktop App Downloads

            | Platform | Architecture | File |
            |----------|--------------|------|
            | macOS | Apple Silicon | `.dmg` |
            | macOS | Intel | `.dmg` |
            | Windows | x64 | `.msi` / `.exe` |
            | Linux | x64 | `.AppImage` / `.deb` |
            | Linux | ARM64 | `.AppImage` / `.deb` |

            #### macOS: Running Unsigned App

            The macOS desktop app is not code-signed. To run it:

            **Method 1: Remove quarantine attribute (Recommended)**
            ```bash
            xattr -cr /Applications/Yaklang\ Dev.app
            ```

            **Method 2: Ad-hoc signing**
            ```bash
            codesign --force --deep --sign - /Applications/Yaklang\ Dev.app
            ```

            **Method 3: System Preferences**
            - Try to open the app → Go to System Preferences → Security & Privacy → General → Click "Open Anyway"

            ### Quick Install (CLI)

            ```bash
            # macOS Apple Silicon
            curl -L https://github.com/${{ github.repository }}/releases/download/${{ needs.fetch-version.outputs.tag }}/yaklang-darwin-arm64 -o /usr/local/bin/yaklang && chmod +x /usr/local/bin/yaklang

            # macOS Intel
            curl -L https://github.com/${{ github.repository }}/releases/download/${{ needs.fetch-version.outputs.tag }}/yaklang-darwin-x64 -o /usr/local/bin/yaklang && chmod +x /usr/local/bin/yaklang

            # Linux x64
            curl -L https://github.com/${{ github.repository }}/releases/download/${{ needs.fetch-version.outputs.tag }}/yaklang-linux-x64 -o /usr/local/bin/yaklang && chmod +x /usr/local/bin/yaklang

            # Linux ARM64
            curl -L https://github.com/${{ github.repository }}/releases/download/${{ needs.fetch-version.outputs.tag }}/yaklang-linux-arm64 -o /usr/local/bin/yaklang && chmod +x /usr/local/bin/yaklang
            ```

            ### Verification

            ```bash
            sha256sum -c checksums.sha256
            ```

            ---

            **Disclaimer**: This is for educational and research purposes only.
          files: |
            release/*
          draft: false
          prerelease: false
