// è‡ªåŠ¨åŒ–æ¼æ´æ‰«æå™¨ - å¹¶è¡Œæ‰§è¡Œæ£€æµ‹è„šæœ¬
// ä½¿ç”¨: yak tools/scanner/auto_scanner.yak --plan-json '<JSON>'

yakit.AutoInitYakit()

planJson = cli.String("plan-json", cli.setRequired(true), cli.setHelp("smart_filter.yak ç”Ÿæˆçš„æ‰§è¡Œè®¡åˆ’ JSON"))
threads = cli.Int("threads", cli.setDefault(5), cli.setHelp("å¹¶å‘çº¿ç¨‹æ•°"))
cli.check()

// è§£ææ‰§è¡Œè®¡åˆ’
executionPlan = json.loads(planJson)

if len(executionPlan) == 0 {
    yakit.Warn("æ‰§è¡Œè®¡åˆ’ä¸ºç©ºï¼Œæ— éœ€æ‰«æ")
    return
}

yakit.Info(sprintf("å¼€å§‹å¹¶è¡Œæ¼æ´æ‰«æï¼Œå…± %d ä¸ªç›®æ ‡ï¼Œå¹¶å‘æ•°ï¼š%d", len(executionPlan), threads))

// ç»Ÿè®¡æ•°æ®
totalScripts = 0
for _, target = range executionPlan {
    totalScripts = totalScripts + len(target["scripts"])
}

yakit.Info(sprintf("æ€»è®¡éœ€è¦è¿è¡Œ %d æ¬¡è„šæœ¬æ£€æµ‹", totalScripts))

// æ¼æ´ç»Ÿè®¡å’Œç»“æœæ”¶é›†
vulnCount = 0
safeCount = 0
errorCount = 0
lock = sync.NewMutex()

// æ”¶é›†æ‰€æœ‰æ¼æ´ç»“æœï¼ˆä¾›AIè§£æï¼‰
vulnResults = []

// æ‰§è¡Œå•ä¸ªè„šæœ¬æ£€æµ‹çš„å‡½æ•°
executeScript = func(flowId, scriptName, url, reason) {
    defer func {
        err = recover()
        if err != nil {
            lock.Lock()
            errorCount++
            lock.Unlock()
            yakit.Error(sprintf("[Flow %d] è„šæœ¬ %s æ‰§è¡Œå¤±è´¥: %v", flowId, scriptName, err))
        }
    }
    
    yakit.Info(sprintf("[Flow %d] æ£€æµ‹ä¸­: %s", flowId, scriptName))
    
    // æ„é€ å‘½ä»¤
    scriptPath = sprintf("script/%s", scriptName)
    cmd = sprintf("yak %s --httpflow-id %d", scriptPath, flowId)
    
    // æ‰§è¡Œè„šæœ¬
    result, err = exec.Command("bash", "-c", cmd)~
    
    if err != nil {
        lock.Lock()
        errorCount++
        lock.Unlock()
        return
    }
    
    output = string(result)
    
    // åˆ¤æ–­æ˜¯å¦å‘ç°æ¼æ´
    if output.Contains("Found Confirmed") || output.Contains("Found Suspected") {
        lock.Lock()
        vulnCount++
        
        // æå–æ¼æ´ç±»å‹
        vulnType = "Unknown"
        if output.Contains("XSS") { vulnType = "XSS" }
        else if output.Contains("SSRF") { vulnType = "SSRF" }
        else if output.Contains("File Upload") { vulnType = "File Upload" }
        else if output.Contains("XXE") { vulnType = "XXE" }
        else if output.Contains("Command Injection") { vulnType = "Command Injection" }
        else if output.Contains("File Read") { vulnType = "File Read" }
        else if output.Contains("Open Redirect") { vulnType = "Open Redirect" }
        else if output.Contains("SSTI") { vulnType = "SSTI" }
        
        severity = "High"
        if output.Contains("Suspected") { severity = "Medium" }
        
        // è®°å½•æ¼æ´
        vulnResults = append(vulnResults, {
            "flow_id": flowId,
            "url": url,
            "vuln_type": vulnType,
            "severity": severity,
            "script": scriptName,
        })
        
        lock.Unlock()
        
        yakit.Output(sprintf("ğŸ”´ [Flow %d] %s - %sæ¼æ´ï¼", flowId, vulnType, severity))
    } else if output.Contains("æœªå‘ç°å¯æµ‹è¯•çš„æœ‰æ•ˆå‚æ•°") {
        lock.Lock()
        safeCount++
        lock.Unlock()
    } else {
        lock.Lock()
        safeCount++
        lock.Unlock()
    }
}

// ä½¿ç”¨åç¨‹æ± å¹¶è¡Œæ‰§è¡Œ
swg = sync.NewSizedWaitGroup(threads)

completedScripts = 0
totalScriptsCount = totalScripts

for _, target = range executionPlan {
    flowId = target["flow_id"]
    url = target["url"]
    scripts = target["scripts"]
    
    for _, scriptInfo = range scripts {
        scriptName = scriptInfo["name"]
        reason = scriptInfo["reason"]
        
        swg.Add()
        
        // é—­åŒ…æ•è·å˜é‡
        currentFlowId = flowId
        currentScriptName = scriptName
        currentUrl = url
        currentReason = reason
        
        go func {
            defer swg.Done()
            
            executeScript(currentFlowId, currentScriptName, currentUrl, currentReason)
            
            lock.Lock()
            completedScripts++
            progress = float64(completedScripts) / float64(totalScriptsCount) * 100.0
            lock.Unlock()
            
            if completedScripts % 10 == 0 {
                yakit.Info(sprintf("è¿›åº¦: %d/%d (%.1f%%)", completedScripts, totalScriptsCount, progress))
            }
        }
    }
}

// ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
swg.Wait()

// è¾“å‡ºç»Ÿè®¡ä¿¡æ¯
yakit.Info("\n" + "="*60)
yakit.Info("æ‰«æå®Œæˆï¼")
yakit.Info(sprintf("  - å‘ç°æ¼æ´: %d ä¸ª", vulnCount))
yakit.Info(sprintf("  - å®‰å…¨æ£€æµ‹: %d ä¸ª", safeCount))
yakit.Info(sprintf("  - æ‰§è¡Œé”™è¯¯: %d ä¸ª", errorCount))
yakit.Info(sprintf("  - æ€»è®¡æ‰§è¡Œ: %d æ¬¡", completedScripts))
yakit.Info("="*60)

// è¾“å‡ºç»“æ„åŒ–ç»“æœï¼ˆä¾›AIè§£æï¼‰
println("\n<<<SCAN_RESULTS_START>>>")
println(json.dumps({
    "summary": {
        "total_targets": len(executionPlan),
        "total_tests": completedScripts,
        "vulnerabilities_found": vulnCount,
        "safe_tests": safeCount,
        "errors": errorCount,
    },
    "vulnerabilities": vulnResults,
}))
println("<<<SCAN_RESULTS_END>>>")

