__DESC__ = "浏览器自动化工具，支持打开网页、获取快照、点击元素、填写表单、执行JavaScript、截图等操作，可用于Web测试和数据提取。"
__VERBOSE_NAME__ = "浏览器自动化工具(agent-browser)"
__KEYWORDS__ = "agent-browser,browser,浏览器,自动化,automation,open,snapshot,快照,click,点击,fill,填写,eval,javascript,js,screenshot,截图,wait,等待,session,会话,headless,无头浏览器,web scraping,网页抓取,爬虫,crawler"

// ============ 命令参数 ============
openUrl = cli.String("open", cli.setRequired(false), cli.setHelp("打开指定URL"))
doClose = cli.Bool("close", cli.setDefault(false), cli.setHelp("关闭浏览器"))
doSnapshot = cli.Bool("snapshot", cli.setDefault(false), cli.setHelp("获取页面快照"))
evalCode = cli.String("eval", cli.setRequired(false), cli.setHelp("执行JavaScript代码或.js文件名"))
screenshotPath = cli.String("screenshot", cli.setRequired(false), cli.setHelp("截图保存路径"))
clickRef = cli.String("click", cli.setRequired(false), cli.setHelp("点击指定元素，如 @e1"))
fillRef = cli.String("fill", cli.setRequired(false), cli.setHelp("填写内容到指定元素（需配合 --text）"))
text = cli.String("text", cli.setRequired(false), cli.setHelp("文本内容，用于fill命令"))
waitRef = cli.String("wait", cli.setRequired(false), cli.setHelp("等待指定元素或毫秒数"))

// ============ 全局选项 ============
session = cli.String("session", cli.setRequired(false), cli.setHelp("浏览器会话名称"))
interactive = cli.Bool("i", cli.setDefault(false), cli.setHelp("snapshot时只显示可交互元素"))
fullPage = cli.Bool("full", cli.setDefault(false), cli.setHelp("全页面截图"))
jsEvalDir = cli.String("js-dir", cli.setDefault("."), cli.setHelp("eval 命令查找 .js 文件的目录；由 web_analyzer.sh 调用时会传入 ../js，单独运行时可指定或使用当前目录"))

cli.check()

yakit.AutoInitYakit()

// 构建基础命令
buildBaseCmd = func() {
    cmdList = ["agent-browser"]
    if session != "" {
        cmdList = append(cmdList, "--session", session)
    }
    return cmdList
}

// 执行命令并获取结果
execCmd = func(cmdArgs...) {
    cmdList = buildBaseCmd()
    for _, arg = range cmdArgs {
        cmdList = append(cmdList, string(arg))
    }
    
    // 对包含空格或特殊字符的参数加引号
    quotedCmd = make([]string)
    for _, part = range cmdList {
        if str.Contains(part, " ") || str.Contains(part, "\"") || str.Contains(part, "\n") {
            part = sprintf("\"%s\"", str.ReplaceAll(part, "\"", "\\\""))
        }
        quotedCmd = append(quotedCmd, part)
    }
    
    cmdStr = str.Join(quotedCmd, " ")
    
    // 日志输出
    if len(cmdStr) > 200 {
        displayCmd = make([]string)
        for _, part = range cmdList {
            if len(part) > 50 {
                displayCmd = append(displayCmd, sprintf("<%d字符>", len(part)))
            } else {
                displayCmd = append(displayCmd, part)
            }
        }
        yakit.Info("执行命令: %v", str.Join(displayCmd, " "))
    } else {
        yakit.Info("执行命令: %v", cmdStr)
    }
    
    result, err = exec.System(cmdStr)
    if err != nil {
        yakit.Error("命令执行失败: %v", err)
        return "", err
    }
    resultStr = string(result)
    if resultStr != "" {
        println("<<<JSON_START>>>")
        println(resultStr)
        println("<<<JSON_END>>>")
    }
    return resultStr, nil
}

// 处理 eval 命令的 JS 文件加载
processJsCode = func(jsCode) {
    if jsCode == "" {
        return ""
    }
    
    if str.HasSuffix(str.ToLower(jsCode), ".js") {
        jsFilePath = file.Join(jsEvalDir, jsCode)
        
        if file.IsExisted(jsFilePath) {
            yakit.Info("检测到JS文件名，从 %v 读取文件内容...", jsFilePath)
            fileContent, readErr = file.ReadFile(jsFilePath)
            if readErr != nil {
                yakit.Error("读取JS文件失败: %v", readErr)
                return jsCode
            }
            yakit.Info("已加载JS文件: %v", jsCode)
            return string(fileContent)
        } else {
            yakit.Warn("JS文件不存在: %v，将作为普通JS代码执行", jsFilePath)
        }
    }
    return jsCode
}

// ============ 命令执行 ============
if openUrl != "" {
    yakit.Info("正在打开URL: %v", openUrl)
    result, err = execCmd("open", openUrl)
    if err == nil {
        yakit.Info("成功打开页面")
    }
} else if doClose {
    yakit.Info("正在关闭浏览器...")
    result, err = execCmd("close")
    if err == nil {
        yakit.Info("浏览器已关闭")
    }
} else if doSnapshot {
    yakit.Info("正在获取页面快照...")
    args = ["snapshot"]
    if interactive {
        args = append(args, "-i")
    }
    result, err = execCmd(args...)
} else if evalCode != "" {
    evalCode = str.Trim(evalCode, " \t\n\r")
    actualCode = processJsCode(evalCode)
    yakit.Info("正在执行JavaScript代码...")
    result, err = execCmd("eval", actualCode)
} else if screenshotPath != "" {
    yakit.Info("正在截图...")
    args = ["screenshot"]
    if fullPage {
        args = append(args, "--full")
    }
    args = append(args, screenshotPath)
    result, err = execCmd(args...)
    if err == nil {
        yakit.Info("截图已保存到: %v", screenshotPath)
    }
} else if clickRef != "" {
    yakit.Info("正在点击元素: %v", clickRef)
    result, err = execCmd("click", clickRef)
    if err == nil {
        yakit.Info("已点击元素: %v", clickRef)
    }
} else if fillRef != "" {
    if text == "" {
        yakit.Error("fill命令需要提供 --text 参数")
    } else {
        yakit.Info("正在填写内容到元素 %v", fillRef)
        result, err = execCmd("fill", fillRef, text)
        if err == nil {
            yakit.Info("已填写内容到元素: %v", fillRef)
        }
    }
} else if waitRef != "" {
    yakit.Info("正在等待: %v", waitRef)
    result, err = execCmd("wait", waitRef)
    if err == nil {
        yakit.Info("等待完成")
    }
} else {
    yakit.Info("浏览器自动化工具")
    yakit.Info("")
    yakit.Info("用法示例:")
    yakit.Info("  yak agent_browser.yak --open http://example.com")
    yakit.Info("  yak agent_browser.yak --snapshot")
    yakit.Info("  yak agent_browser.yak --snapshot -i")
    yakit.Info("  yak agent_browser.yak --click @e1")
    yakit.Info("  yak agent_browser.yak --fill @e1 --text \"hello\"")
    yakit.Info("  yak agent_browser.yak --eval \"document.title\"")
    yakit.Info("  yak agent_browser.yak --eval script.js")
    yakit.Info("  yak agent_browser.yak --screenshot output.png --full")
    yakit.Info("  yak agent_browser.yak --wait @e1")
    yakit.Info("  yak agent_browser.yak --wait 2000")
    yakit.Info("  yak agent_browser.yak --close")
    yakit.Info("")
    yakit.Info("全局选项:")
    yakit.Info("  --session <name>   浏览器会话名称")
    yakit.Info("  --headed           显示浏览器窗口")
    yakit.Info("  --json             JSON格式输出")
    yakit.Info("  --js-dir <path>    eval查找.js文件的目录")
}
