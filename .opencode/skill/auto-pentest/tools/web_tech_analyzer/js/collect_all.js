(async () => {
  const stack = {
    vue: !!(window.Vue || window.__VUE_DEVTOOLS_GLOBAL_HOOK__ || document.querySelector('[data-v-]')),
    react: !!(window.__REACT_DEVTOOLS_GLOBAL_HOOK__ || document.querySelector('[data-reactroot], [data-reactid]')),
    angular: !!(window.ng || document.querySelector('[ng-version]')),
    jquery: !!(window.jQuery || window.$),
    layui: !!(window.layui),
    bootstrap: !!(window.bootstrap),
    echarts: !!(window.echarts),
    axios: !!(window.axios),
    fetch: typeof window.fetch === 'function',
    webpack: !!(window.__webpack_require__ || document.querySelector('script[src*="chunk"]')),
    vite: !!(window.__VITE__ || document.querySelector('script[src*="/assets/"]'))
  };

  const scripts = Array.from(document.scripts).map(s => ({
    src: s.src || null,
    type: s.type || null,
    async: !!s.async,
    defer: !!s.defer,
    nomodule: !!s.noModule,
    inline: !s.src,
    textSample: !s.src ? s.textContent.trim().slice(0, 200) : null
  }));

  const inlineScripts = Array.from(document.scripts)
    .filter(s => !s.src)
    .map(s => ({
      len: s.textContent.length,
      text: s.textContent.trim().slice(0, 1000)
    }));
  const inlineScriptCount = inlineScripts.length;

  const dataAttrs = Array.from(document.querySelectorAll('*'))
    .filter(el => el.dataset && Object.keys(el.dataset).length > 0)
    .slice(0, 100)
    .map(el => ({ tag: el.tagName.toLowerCase(), id: el.id || null, dataset: el.dataset }));

  const globals = Object.keys(window)
    .filter(k =>
      k.startsWith('$') ||
      k.includes('VUE') ||
      k.includes('REACT') ||
      k.includes('ANGULAR') ||
      k.startsWith('__') && (k.includes('ROUTES') || k.includes('ROUTER') || k.includes('HOOK'))
    )
    .slice(0, 100);

  const requirejsConfig = (() => {
    try {
      return (window.requirejs && window.requirejs.s && window.requirejs.s.contexts && window.requirejs.s.contexts._ && window.requirejs.s.contexts._.config) || null;
    } catch (e) { return null; }
  })();

  const requireFetched = (() => {
    try {
      return (window.requirejs && window.requirejs.s && window.requirejs.s.contexts && window.requirejs.s.contexts._ && window.requirejs.s.contexts._.urlFetched)
        ? Object.keys(window.requirejs.s.contexts._.urlFetched)
        : [];
    } catch (e) { return []; }
  })();

  const resources = performance.getEntriesByType('resource')
    .filter(e => ['script','fetch','xmlhttprequest','other'].includes(e.initiatorType))
    .map(e => ({ name: e.name, initiatorType: e.initiatorType }));

  const websocketEntries = performance.getEntriesByType('resource')
    .filter(e => e.initiatorType === 'websocket')
    .map(e => e.name);

  const prefetchPreload = Array.from(document.querySelectorAll('link[rel]'))
    .filter(l => ['preload','prefetch'].includes(l.rel))
    .map(l => ({ rel: l.rel, href: l.href, as: l.as || null }));

  const modules = Array.from(document.querySelectorAll('script[type="module"]'))
    .map(s => ({ src: s.src || null, inline: !s.src, textSample: !s.src ? s.textContent.trim().slice(0,200) : null }));

  const importmaps = Array.from(document.querySelectorAll('script[type="importmap"]'))
    .map(s => ({ textSample: s.textContent.trim().slice(0,500) }));

  const supported = 'serviceWorker' in navigator;
  let registrations = [];
  if (supported) {
    try {
      const list = await navigator.serviceWorker.getRegistrations();
      registrations = list.map(r => r.active && r.active.scriptURL).filter(Boolean);
    } catch (e) {}
  }
  const controller = supported && navigator.serviceWorker.controller
    ? navigator.serviceWorker.controller.scriptURL
    : null;

  return JSON.stringify({
    stack,
    scripts,
    inlineScripts,
    inlineScriptCount,
    dataAttrs,
    globals,
    sysId: window.$sysId || null,
    tenantId: window.$tenantId || null,
    cloudwise: window.$cloudwise || null,
    requirejsConfig,
    requireFetched,
    resources,
    websocketEntries,
    prefetchPreload,
    modules,
    importmaps,
    serviceWorker: { supported, controller, registrations }
  });
})();
