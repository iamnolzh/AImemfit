(() => {
  // 自适应分析器 - 根据检测结果选择最佳分析策略
  const analysis = {
    detected: {},
    recommendations: [],
    analysisPlan: [],
    prioritizedScripts: []
  };

  // 首先运行通用检测器获取技术栈信息
  let detectionResult;
  try {
    // 这里会动态执行universal_detector.js的内容
    const detectorScript = `(() => {
      const detection = {
        frameworks: {},
        libraries: {},
        bundlers: {},
        network: {},
        appTypes: {},
        features: {},
        resources: {}
      };

      // 框架检测
      detection.frameworks = {
        vue: !!(window.Vue || window.__VUE_DEVTOOLS_GLOBAL_HOOK__ || document.querySelector('[data-v-]')),
        react: !!(window.__REACT_DEVTOOLS_GLOBAL_HOOK__ || document.querySelector('[data-reactroot], [data-reactid]')),
        angular: !!(window.ng || document.querySelector('[ng-version]')),
        jquery: !!(window.jQuery || window.$),
        layui: !!window.layui
      };

      // 库检测
      detection.libraries = {
        bootstrap: !!(window.bootstrap || document.querySelector('[class*="btn btn-"]')),
        echarts: !!window.echarts,
        d3: !!window.d3
      };

      // 打包工具检测
      detection.bundlers = {
        webpack: !!(window.__webpack_require__ || document.querySelector('script[src*="chunk"]')),
        vite: !!(window.__VITE__ || document.querySelector('script[src*="/assets/"]')),
        requirejs: !!window.requirejs
      };

      // 网络库检测
      detection.network = {
        axios: !!window.axios,
        fetch: typeof window.fetch === 'function'
      };

      // 应用类型检测
      detection.appTypes = {
        loginPage: !!document.querySelector('input[type="password"], [class*="login"]'),
        adminSystem: !!document.querySelector('[class*="admin"], [class*="dashboard"]'),
        spa: !!(window.history.pushState || window.router),
        pwa: !!('serviceWorker' in navigator)
      };

      // 技术特征检测
      detection.features = {
        es6Modules: !!document.querySelector('script[type="module"]'),
        inlineScripts: Array.from(document.scripts).some(s => !s.src),
        dataAttributes: !!document.querySelector('[data-*]'),
        preload: !!document.querySelector('link[rel="preload"]')
      };

      return detection;
    })()`;

    detectionResult = eval(detectorScript);
  } catch (e) {
    analysis.error = 'Failed to run universal detector: ' + e.message;
    return JSON.stringify(analysis);
  }

  analysis.detected = detectionResult;

  // 基于检测结果生成推荐分析计划
  const detected = detectionResult;

  // 1. 框架特定的分析
  if (detected.frameworks.vue) {
    analysis.recommendations.push('Vue.js application detected - use Vue-specific route analysis');
    analysis.analysisPlan.push({
      category: 'framework',
      script: 'vue_routes.js',
      priority: 'high',
      reason: 'Extract Vue Router configuration and dynamic routes'
    });
    analysis.prioritizedScripts.push('vue_routes.js');
  }

  if (detected.frameworks.react) {
    analysis.recommendations.push('React application detected - use React-specific analysis');
    analysis.analysisPlan.push({
      category: 'framework',
      script: 'react_routes.js',
      priority: 'high',
      reason: 'Extract React Router configuration'
    });
    analysis.prioritizedScripts.push('react_routes.js');
  }

  if (detected.frameworks.angular) {
    analysis.recommendations.push('Angular application detected');
    analysis.analysisPlan.push({
      category: 'framework',
      script: 'angular_routes.js',
      priority: 'high',
      reason: 'Extract Angular Router configuration'
    });
    analysis.prioritizedScripts.push('angular_routes.js');
  }

  if (detected.frameworks.jquery) {
    analysis.recommendations.push('jQuery detected - check for AJAX patterns');
    analysis.analysisPlan.push({
      category: 'library',
      script: 'hook_network.js',
      priority: 'medium',
      reason: 'Monitor jQuery AJAX calls'
    });
  }

  if (detected.frameworks.layui) {
    analysis.recommendations.push('Layui UI framework detected');
    analysis.analysisPlan.push({
      category: 'library',
      script: 'collect_data_attrs.js',
      priority: 'medium',
      reason: 'Layui often uses data attributes for configuration'
    });
  }

  // 2. 库特定的分析
  if (detected.libraries.bootstrap) {
    analysis.recommendations.push('Bootstrap CSS framework detected');
    analysis.analysisPlan.push({
      category: 'library',
      script: 'collect_scripts.js',
      priority: 'low',
      reason: 'Check Bootstrap-related scripts and versions'
    });
  }

  if (detected.libraries.echarts) {
    analysis.recommendations.push('ECharts visualization library detected');
    analysis.analysisPlan.push({
      category: 'library',
      script: 'collect_runtime_config.js',
      priority: 'medium',
      reason: 'ECharts configurations might be in global variables'
    });
  }

  // 3. 打包工具特定的分析
  if (detected.bundlers.webpack) {
    analysis.recommendations.push('Webpack bundler detected');
    analysis.analysisPlan.push({
      category: 'bundler',
      script: 'collect_perf_resources.js',
      priority: 'medium',
      reason: 'Analyze Webpack chunk loading patterns'
    });
  }

  if (detected.bundlers.vite) {
    analysis.recommendations.push('Vite bundler detected');
    analysis.analysisPlan.push({
      category: 'bundler',
      script: 'collect_es_modules.js',
      priority: 'high',
      reason: 'Vite uses ES modules extensively'
    });
    analysis.prioritizedScripts.push('collect_es_modules.js');
  }

  if (detected.bundlers.requirejs) {
    analysis.recommendations.push('RequireJS detected');
    analysis.analysisPlan.push({
      category: 'bundler',
      script: 'collect_requirejs_config.js',
      priority: 'high',
      reason: 'Extract RequireJS module configuration'
    });
    analysis.analysisPlan.push({
      category: 'bundler',
      script: 'collect_requirejs_fetched.js',
      priority: 'high',
      reason: 'Track RequireJS module loading'
    });
    analysis.prioritizedScripts.push('collect_requirejs_config.js', 'collect_requirejs_fetched.js');
  }

  // 4. 网络库特定的分析
  if (detected.network.axios) {
    analysis.recommendations.push('Axios HTTP client detected');
    analysis.analysisPlan.push({
      category: 'network',
      script: 'hook_network.js',
      priority: 'high',
      reason: 'Intercept Axios requests for API discovery'
    });
    analysis.prioritizedScripts.push('hook_network.js');
  }

  if (detected.network.fetch && !detected.network.axios) {
    analysis.recommendations.push('Native Fetch API usage detected');
    analysis.analysisPlan.push({
      category: 'network',
      script: 'hook_network.js',
      priority: 'high',
      reason: 'Monitor Fetch API calls'
    });
    analysis.prioritizedScripts.push('hook_network.js');
  }

  // 5. 应用类型特定的分析
  if (detected.appTypes.loginPage) {
    analysis.recommendations.push('Login page detected');
    analysis.analysisPlan.push({
      category: 'appType',
      script: 'collect_scripts.js',
      priority: 'high',
      reason: 'Analyze authentication-related scripts'
    });
    analysis.analysisPlan.push({
      category: 'appType',
      script: 'collect_runtime_config.js',
      priority: 'high',
      reason: 'Look for authentication configuration'
    });
  }

  if (detected.appTypes.adminSystem) {
    analysis.recommendations.push('Admin/management system detected');
    analysis.analysisPlan.push({
      category: 'appType',
      script: 'routes_all.js',
      priority: 'high',
      reason: 'Extract admin panel routes and menu structure'
    });
    analysis.analysisPlan.push({
      category: 'appType',
      script: 'collect_generic_config.js',
      priority: 'high',
      reason: 'Discover admin system configurations'
    });
  }

  if (detected.appTypes.pwa) {
    analysis.recommendations.push('PWA (Progressive Web App) detected');
    analysis.analysisPlan.push({
      category: 'appType',
      script: 'detect_service_worker.js',
      priority: 'high',
      reason: 'Analyze Service Worker implementation'
    });
    analysis.prioritizedScripts.push('detect_service_worker.js');
  }

  // 6. 技术特征特定的分析
  if (detected.features.es6Modules) {
    analysis.recommendations.push('ES6 modules detected');
    analysis.analysisPlan.push({
      category: 'feature',
      script: 'collect_es_modules.js',
      priority: 'high',
      reason: 'Analyze ES6 module usage and dependencies'
    });
    analysis.prioritizedScripts.push('collect_es_modules.js');
  }

  if (detected.features.inlineScripts) {
    analysis.recommendations.push('Inline scripts detected');
    analysis.analysisPlan.push({
      category: 'feature',
      script: 'collect_inline.js',
      priority: 'high',
      reason: 'Extract and analyze inline JavaScript code'
    });
    analysis.prioritizedScripts.push('collect_inline.js');
  }

  if (detected.features.dataAttributes) {
    analysis.recommendations.push('Data attributes detected');
    analysis.analysisPlan.push({
      category: 'feature',
      script: 'collect_data_attrs.js',
      priority: 'medium',
      reason: 'Extract data-* attributes for configuration discovery'
    });
  }

  if (detected.features.preload) {
    analysis.recommendations.push('Resource preloading detected');
    analysis.analysisPlan.push({
      category: 'feature',
      script: 'collect_prefetch_preload.js',
      priority: 'medium',
      reason: 'Analyze preload/prefetch resource hints'
    });
  }

  // 7. 通用分析（始终执行）
  analysis.analysisPlan.push({
    category: 'universal',
    script: 'collect_key_scripts.js',
    priority: 'high',
    reason: 'Rank and classify scripts for SSA candidate selection'
  });

  analysis.analysisPlan.push({
    category: 'universal',
    script: 'collect_all.js',
    priority: 'high',
    reason: 'Comprehensive analysis of all detectable features'
  });

  analysis.analysisPlan.push({
    category: 'universal',
    script: 'detect_dynamic_vars.js',
    priority: 'high',
    reason: 'Dynamic discovery of configuration variables'
  });

  analysis.analysisPlan.push({
    category: 'universal',
    script: 'extract_dynamic_routes.js',
    priority: 'medium',
    reason: 'Extract routes from various sources'
  });

  // 去重并排序优先级脚本
  analysis.prioritizedScripts = [...new Set(analysis.prioritizedScripts)];

  // 按优先级排序分析计划
  const priorityOrder = { high: 1, medium: 2, low: 3 };
  analysis.analysisPlan.sort((a, b) => priorityOrder[a.priority] - priorityOrder[b.priority]);

  return JSON.stringify(analysis);
})();
