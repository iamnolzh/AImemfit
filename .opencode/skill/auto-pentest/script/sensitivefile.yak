__DESC__ = "检测敏感文件和目录暴露"
__VERBOSE_NAME__ = "敏感文件检测"
__KEYWORDS__ = "sensitive-files,information-disclosure"

// 配置项
debug = false
threads = 5

// -------------------------------------------------------------------
// CLI 参数定义
// -------------------------------------------------------------------
flowIDStr = cli.String(
    "httpflow-id", 
    cli.setVerboseName("HTTPFlowID"), 
    cli.setHelp("History 中的 HTTPFlow ID,用于获取请求/响应包内容"), 
    cli.setRequired(true), 
)
cli.check()

// 辅助输出函数
aiOut = msg => { 
    try {
        yakit.AIOutput(msg) 
    } catch {
        println(msg)
    }
}

// -------------------------------------------------------------------
// 核心数据结构
// -------------------------------------------------------------------

// 敏感文件路径列表
sensitivePaths = [
    {"path": "/.git/config", "keyword": "[core]", "severity": "high"},
    {"path": "/.env", "keyword": "DB_", "severity": "high"},
    {"path": "/robots.txt", "keyword": "User-agent", "severity": "info"},
    {"path": "/.DS_Store", "keyword": "", "severity": "low"},
    {"path": "/web.config", "keyword": "<configuration>", "severity": "medium"},
    {"path": "/WEB-INF/web.xml", "keyword": "<web-app", "severity": "high"},
    {"path": "/config.php", "keyword": "", "severity": "medium"},
    {"path": "/.htaccess", "keyword": "", "severity": "medium"},
    {"path": "/backup.zip", "keyword": "", "severity": "high"},
    {"path": "/database.sql", "keyword": "", "severity": "high"},
]

// -------------------------------------------------------------------
// 核心逻辑
// -------------------------------------------------------------------

// 检查文件是否存在
checkFile = func(responseRaw, keyword) {
    if responseRaw == nil { return false }
    
    r = string(responseRaw)
    
    // 检查HTTP状态码
    if !str.Contains(r, "HTTP/1.1 200") && !str.Contains(r, "HTTP/1.0 200") {
        return false
    }
    
    // 如果有关键字，检查内容
    if keyword != "" {
        return str.Contains(r, keyword)
    }
    
    return true
}

// -------------------------------------------------------------------
// 主程序入口
// -------------------------------------------------------------------

flowID = parseInt(flowIDStr)
flowsChan := db.QueryHTTPFlowsByID(flowID)
flow = nil
for f := range flowsChan {
    flow = f
    break
}

if flow == nil {
    aiOut(sprintf("HTTPFlow 查询失败: 未找到 ID 为 %v 的请求", flowID))
    return
}

reqBytes = flow.GetRequest()
if reqBytes == nil { reqBytes = []byte(flow.Request) }
if reqBytes == nil || len(reqBytes) == 0 {
    aiOut("请求包为空,无法检测")
    return
}

isHttps = flow.IsHTTPS
freq, err := fuzz.HTTPRequest(reqBytes, fuzz.https(isHttps))
if err != nil {
    aiOut(sprintf("解析请求失败: %v", err))
    return
}

aiOut(sprintf("开始敏感文件检测 (Target: %s)...", flow.Url))

// 遍历敏感路径
findings = []
swg = sync.NewSizedWaitGroup(threads)

for _, item = range sensitivePaths {
    testPath = item.path
    keyword = item.keyword
    severity = item.severity
    
    swg.Add()
    go func {
        defer swg.Done()
        
        // Fuzz URL路径
        fuzzReq = freq.FuzzPath(testPath)
        res, err = fuzzReq.ExecFirst()
        
        if err != nil {
            if debug { aiOut(sprintf("请求失败 (%s): %v", testPath, err)) }
            return
        }
        
        if res == nil { return }
        
        // 检查文件
        if checkFile(res.ResponseRaw, keyword) {
            findings = append(findings, {"path": testPath, "severity": severity})
            aiOut(sprintf("✓ 发现敏感文件: %s", testPath))
            
            risk.NewRisk(
                flow.Url + testPath,
                risk.title(sprintf("Sensitive File Exposure: %s", testPath)),
                risk.titleVerbose(sprintf("敏感文件暴露: %s", testPath)),
                risk.details({"path": testPath, "url": flow.Url}),
                risk.type("sensitive-file-disclosure"),
                risk.severity(severity),
                risk.payload(testPath),
                risk.request(res.RequestRaw),
                risk.response(res.ResponseRaw),
                risk.description(sprintf("服务器暴露了敏感文件 %s，可能泄露重要信息。", testPath)),
                risk.solution("1. 删除或限制敏感文件访问。\n2. 配置Web服务器拒绝访问敏感路径。")
            )
        }
    }
}

swg.Wait()

if len(findings) == 0 {
    aiOut("未发现敏感文件")
}

aiOut(sprintf("=== 敏感文件检测完成, 发现 %d 个问题 ===", len(findings)))
