__DESC__ = "检测HTTP响应安全头缺失和Server信息泄露"
__VERBOSE_NAME__ = "HTTP安全头检测"
__KEYWORDS__ = "security-headers,http-headers,information-disclosure"

// 配置项
debug = false

// -------------------------------------------------------------------
// CLI 参数定义
// -------------------------------------------------------------------
flowIDStr = cli.String(
    "httpflow-id", 
    cli.setVerboseName("HTTPFlowID"), 
    cli.setHelp("History 中的 HTTPFlow ID,用于获取请求/响应包内容"), 
    cli.setRequired(true), 
)
cli.check()

// 辅助输出函数
aiOut = msg => { 
    try {
        yakit.AIOutput(msg) 
    } catch {
        println(msg)
    }
}

// -------------------------------------------------------------------
// 核心数据结构
// -------------------------------------------------------------------

// 必须的安全头
requiredHeaders = [
    "X-Frame-Options",
    "X-Content-Type-Options",
    "Content-Security-Policy",
    "Strict-Transport-Security",
]

// -------------------------------------------------------------------
// 核心逻辑
// -------------------------------------------------------------------

// 检查响应头
checkSecurityHeaders = func(responseRaw) {
    if responseRaw == nil { return [] }
    
    r = string(responseRaw)
    issues = []
    
    // 检查缺失的安全头
    for _, hdr = range requiredHeaders {
        if !str.Contains(r, hdr) {
            issues = append(issues, {"type": "missing_header", "header": hdr})
        }
    }
    
    // 检查Server信息泄露
    if str.Contains(r, "Server:") {
        lines = str.Split(r, "\n")
        for _, line = range lines {
            if str.HasPrefix(line, "Server:") {
                serverInfo = str.Trim(line[7:], " \r")
                issues = append(issues, {"type": "server_leak", "value": serverInfo})
                break
            }
        }
    }
    
    return issues
}

// -------------------------------------------------------------------
// 主程序入口
// -------------------------------------------------------------------

flowID = parseInt(flowIDStr)
flowsChan := db.QueryHTTPFlowsByID(flowID)
flow = nil
for f := range flowsChan {
    flow = f
    break
}

if flow == nil {
    aiOut(sprintf("HTTPFlow 查询失败: 未找到 ID 为 %v 的请求", flowID))
    return
}

reqBytes = flow.GetRequest()
if reqBytes == nil { reqBytes = []byte(flow.Request) }
if reqBytes == nil || len(reqBytes) == 0 {
    aiOut("请求包为空,无法检测")
    return
}

isHttps = flow.IsHTTPS
freq, err := fuzz.HTTPRequest(reqBytes, fuzz.https(isHttps))
if err != nil {
    aiOut(sprintf("解析请求失败: %v", err))
    return
}

aiOut(sprintf("开始安全头检测 (Target: %s)...", flow.Url))

// 发送请求
res, err = freq.ExecFirst()
if err != nil {
    aiOut(sprintf("请求失败: %v", err))
    return
}

if res == nil {
    aiOut("未收到响应")
    return
}

// 检查安全头
issues = checkSecurityHeaders(res.ResponseRaw)

if len(issues) > 0 {
    for _, issue = range issues {
        if issue.type == "missing_header" {
            aiOut(sprintf("✓ 缺失安全头: %s", issue.header))
            
            risk.NewRisk(
                flow.Url,
                risk.title(sprintf("Missing Security Header: %s", issue.header)),
                risk.titleVerbose(sprintf("缺失安全响应头: %s", issue.header)),
                risk.details({"missing_header": issue.header, "url": flow.Url}),
                risk.type("missing-security-header"),
                risk.severity("low"),
                risk.request(res.RequestRaw),
                risk.response(res.ResponseRaw),
                risk.description(sprintf("响应中缺少安全头 %s，可能导致安全风险。", issue.header)),
                risk.solution(sprintf("在服务器响应中添加 %s 头。", issue.header))
            )
        } else if issue.type == "server_leak" {
            aiOut(sprintf("✓ Server信息泄露: %s", issue.value))
            
            risk.NewRisk(
                flow.Url,
                risk.title(sprintf("Server Information Disclosure: %s", flow.Url)),
                risk.titleVerbose(sprintf("Server信息泄露: %s", flow.Url)),
                risk.details({"server_info": issue.value, "url": flow.Url}),
                risk.type("information-disclosure"),
                risk.severity("info"),
                risk.request(res.RequestRaw),
                risk.response(res.ResponseRaw),
                risk.description(sprintf("响应中暴露了服务器信息: %s", issue.value)),
                risk.solution("移除或隐藏 Server 响应头。")
            )
        }
    }
} else {
    aiOut("未发现安全头问题")
}

aiOut(sprintf("=== 安全头检测完成, 发现 %d 个问题 ===", len(issues)))
